{% extends "base.html" %}
{% load static %}
{% load form_tags %}
{% load button_tags %}

{% block content %}
<div class="bg-white shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-gray-900">{{ title }}</h2>
            <a href="{{ back_url }}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
                </svg>
                Back to Trailers
            </a>
        </div>

        {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
            <div class="rounded-md p-4 {% if message.tags == 'success' %}bg-green-50 text-green-700{% elif message.tags == 'warning' %}bg-yellow-50 text-yellow-700{% else %}bg-red-50 text-red-700{% endif %}">
                <div class="flex">
                    <div class="flex-shrink-0">
                        {% if message.tags == 'success' %}
                        <svg class="h-5 w-5 text-green-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                        </svg>
                        {% elif message.tags == 'warning' %}
                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                        {% else %}
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                        {% endif %}
                    </div>
                    <div class="ml-3">
                        <p class="text-sm font-medium whitespace-pre-line">{{ message }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="post" class="space-y-4">
            {% csrf_token %}

            <!-- Trailer Info -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-medium text-gray-900 mb-2">Trailer Information</h3>
                <p class="text-sm text-gray-600">
                    <strong>Trailer:</strong> {{ trailer.number }} - {{ trailer.model }}<br>
                    <strong>Category:</strong> {{ trailer.category }}<br>
                    {% if trailer.width and trailer.length %}
                    <strong>Size:</strong> {{ trailer.length|floatformat:"-1" }}'x{{ trailer.width|floatformat:"-1" }}'
                    {% endif %}
                </p>
            </div>

            <!-- Service Management Info -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">üí° Service Management Tip</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>
                                <strong>Need to manage existing services?</strong> You can view, edit, or delete all services for this trailer from the main service management page.
                                Use "End Early" for active services or "Cancel" for future services that are no longer needed.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Period -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label for="{{ form.start_datetime.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        Service Start Date & Time{% if form.start_datetime.field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <div class="mt-1">
                        {{ form.start_datetime|addclass:"shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-2 border-gray-300 rounded-md py-2.5"|addattr:"placeholder:Start date & time" }}
                        {% if form.start_datetime.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {% for error in form.start_datetime.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    <!-- compact: help text via placeholder -->
                </div>

                <div>
                    <label for="{{ form.end_datetime.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        Service End Date & Time{% if form.end_datetime.field.required %}<span class="text-red-500">*</span>{% endif %}
                    </label>
                    <div class="mt-1">
                        {{ form.end_datetime|addclass:"shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-2 border-gray-300 rounded-md py-2.5"|addattr:"placeholder:End date & time" }}
                        {% if form.end_datetime.errors %}
                        <div class="text-red-600 text-sm mt-1">
                            {% for error in form.end_datetime.errors %}
                            <p>{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>

                </div>
            </div>

            <!-- Description -->
            <div class="sm:col-span-2">
                <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700">
                    Service Description{% if form.description.field.required %}<span class="text-red-500">*</span>{% endif %}
                </label>
                <div class="mt-1">
                    {{ form.description|addclass:"shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-2 border-gray-300 rounded-md py-2.5"|addattr:"placeholder:Optional description" }}
                    {% if form.description.errors %}
                    <div class="text-red-600 text-sm mt-1">
                        {% for error in form.description.errors %}
                        <p>{{ error }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>

            </div>

            <!-- Form errors -->
            {% if form.non_field_errors %}
            <div class="rounded-md bg-red-50 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-red-800">Please correct the following errors:</h3>
                        <div class="mt-2 text-sm text-red-700">
                            <ul class="list-disc pl-5 space-y-1">
                                {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Conflict Warning -->
            {% if form.show_conflict_warning %}
            <div class="rounded-md bg-yellow-50 p-4 border-l-4 border-yellow-400">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-yellow-800">‚ö†Ô∏è Scheduling Conflict Warning</h3>
                        <div class="mt-2 text-sm text-yellow-700">
                            <p class="mb-3">This service period overlaps with <strong>{{ form.conflicts|length }} existing contract{{ form.conflicts|length|pluralize }}</strong>:</p>

                            <div class="bg-white rounded-md p-3 border border-yellow-200">
                                {% for conflict in form.conflicts %}
                                <div class="flex justify-between items-center py-2 {% if not forloop.last %}border-b border-gray-200{% endif %}">
                                    <div>
                                        <div class="font-medium text-gray-900">Contract #{{ conflict.id }} - {{ conflict.customer_name }}</div>
                                        <div class="text-sm text-gray-600">
                                            üìû {{ conflict.customer_phone }} |
                                            üìÖ {{ conflict.start_datetime }} ‚Üí {{ conflict.end_datetime }}
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        {% if conflict.is_returned %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                            Returned
                                        </span>
                                        {% elif conflict.is_picked_up %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                            Picked Up
                                        </span>
                                        {% else %}
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
                                            Pending
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="mt-4 p-3 bg-yellow-100 rounded-md">
                                <p class="text-sm text-yellow-800">
                                    <strong>‚ö†Ô∏è Impact:</strong> Scheduling this service will make the trailer unavailable during active rentals.
                                    Customers may arrive to find their reserved trailer under maintenance.
                                </p>
                            </div>

                            <div class="mt-4 flex items-center space-x-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="confirm-conflict" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                    <span class="ml-2 text-sm text-yellow-800">I understand the conflicts and want to proceed anyway</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Submit buttons -->
            <div class="flex justify-end space-x-3">
                <a href="{{ back_url }}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Cancel
                </a>
                <button type="submit" id="submit-btn" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    {{ button_text }}
                </button>
            </div>

            <!-- Hidden field for force creation -->
            <input type="hidden" id="force-create" name="force_create" value="false">
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'rental_scheduler/js/date_picker.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize date pickers for start and end datetime fields
        const startDateField = document.getElementById('{{ form.start_datetime.id_for_label }}');
        const endDateField = document.getElementById('{{ form.end_datetime.id_for_label }}');

        if (startDateField) {
            flatpickr(startDateField, {
                enableTime: true,
                dateFormat: "m/d/Y h:i K",
                time_24hr: false,
                minuteIncrement: 15,
                defaultHour: 7,
                defaultMinute: 0
            });
        }

        if (endDateField) {
            flatpickr(endDateField, {
                enableTime: true,
                dateFormat: "m/d/Y h:i K",
                time_24hr: false,
                minuteIncrement: 15,
                defaultHour: 17,
                defaultMinute: 0
            });
        }

        // Handle conflict confirmation logic
        const form = document.querySelector('form');
        const submitBtn = document.getElementById('submit-btn');
        const confirmCheckbox = document.getElementById('confirm-conflict');
        const forceCreateField = document.getElementById('force-create');
        const conflictWarning = document.querySelector('[class*="bg-yellow-50"]'); // Conflict warning div

        // Initially disable submit button if conflicts exist and not confirmed
        if (conflictWarning && confirmCheckbox) {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            submitBtn.title = 'Please confirm you understand the conflicts before proceeding';

            // Enable/disable submit button based on checkbox
            confirmCheckbox.addEventListener('change', function () {
                if (this.checked) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitBtn.title = '';

                    // Update button text to indicate force creation
                    const originalText = '{{ button_text }}';
                    const overrideText = originalText.includes('Update') ? 'Update Service (Override Conflicts)' : 'Schedule Service (Override Conflicts)';
                    submitBtn.innerHTML = submitBtn.innerHTML.replace(originalText, overrideText);
                } else {
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    submitBtn.title = 'Please confirm you understand the conflicts before proceeding';

                    // Restore original button text
                    const currentText = submitBtn.innerHTML;
                    if (currentText.includes('(Override Conflicts)')) {
                        submitBtn.innerHTML = currentText.replace(/ \(Override Conflicts\)/, '');
                    }
                }
            });

            // Handle form submission
            form.addEventListener('submit', function (e) {
                if (confirmCheckbox.checked) {
                    // Set force_create to true when user has confirmed
                    forceCreateField.value = 'true';

                    // Update submit button to show processing
                    submitBtn.disabled = true;
                    const processingText = '{{ button_text }}'.includes('Update') ? '‚ö†Ô∏è Updating Service...' : '‚ö†Ô∏è Creating Service...';
                    submitBtn.innerHTML = processingText;
                }
            });
        }
    });
</script>
{% endblock %}