{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-900">{{ title }}</h1>
            <div class="flex space-x-3">
                <a href="{% url 'rental_scheduler:invoice_detail' invoice.pk %}" 
                   class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    Back to Invoice
                </a>
            </div>
        </div>

        <!-- Invoice Summary -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-2">Invoice Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <span class="text-sm font-medium text-blue-700">Invoice:</span>
                    <span class="ml-2 text-blue-900">{{ invoice.invoice_number }}</span>
                </div>
                <div>
                    <span class="text-sm font-medium text-blue-700">Customer:</span>
                    <span class="ml-2 text-blue-900">{{ invoice.job.display_name }}</span>
                </div>
                <div>
                    <span class="text-sm font-medium text-blue-700">Current Total:</span>
                    <span class="ml-2 text-blue-900 font-bold">${{ invoice.total_amount|floatformat:2 }}</span>
                </div>
            </div>
        </div>

        <!-- Line Item Form -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Line Item Details -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label for="{{ form.item_code.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Item Code
                        </label>
                        {{ form.item_code }}
                        {% if form.item_code.errors %}
                            <div class="text-red-600 text-sm mt-1">{{ form.item_code.errors.0 }}</div>
                        {% endif %}
                        <p class="text-sm text-gray-500 mt-1">Optional SKU or product code</p>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Description *
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-red-600 text-sm mt-1">{{ form.description.errors.0 }}</div>
                        {% endif %}
                        <p class="text-sm text-gray-500 mt-1">Detailed description of the item or service</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.invoice.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Invoice
                        </label>
                        {{ form.invoice }}
                        {% if form.invoice.errors %}
                            <div class="text-red-600 text-sm mt-1">{{ form.invoice.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="{{ form.qty.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Quantity *
                        </label>
                        {{ form.qty }}
                        {% if form.qty.errors %}
                            <div class="text-red-600 text-sm mt-1">{{ form.qty.errors.0 }}</div>
                        {% endif %}
                        <p class="text-sm text-gray-500 mt-1">Number of units or hours</p>
                    </div>
                    
                    <div>
                        <label for="{{ form.price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Unit Price *
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">$</span>
                            {{ form.price }}
                        </div>
                        {% if form.price.errors %}
                            <div class="text-red-600 text-sm mt-1">{{ form.price.errors.0 }}</div>
                        {% endif %}
                        <p class="text-sm text-gray-500 mt-1">Price per unit or per hour</p>
                    </div>
                </div>
                
                <!-- Calculated Total Preview -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h4 class="text-lg font-medium text-gray-900 mb-3">Line Total Preview</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <span class="text-sm font-medium text-gray-500">Quantity:</span>
                            <span class="ml-2 text-gray-900" id="preview-qty">0</span>
                        </div>
                        <div>
                            <span class="text-sm font-medium text-gray-500">Unit Price:</span>
                            <span class="ml-2 text-gray-900" id="preview-price">$0.00</span>
                        </div>
                        <div>
                            <span class="text-sm font-bold text-gray-900">Line Total:</span>
                            <span class="ml-2 text-blue-600 font-bold text-lg" id="preview-total">$0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="border-t border-gray-200 pt-6">
                    <div class="flex justify-end space-x-3">
                        <a href="{% url 'rental_scheduler:invoice_detail' invoice.pk %}" 
                           class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            Cancel
                        </a>
                        <button type="submit" 
                                class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                            {% if object %}Update Line Item{% else %}Add Line Item{% endif %}
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
/* Form field styling */
input[type="text"], input[type="email"], input[type="number"], input[type="date"], textarea, select {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    line-height: 1.25rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

input[type="text"]:focus, input[type="email"]:focus, input[type="number"]:focus, input[type="date"]:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Price field with dollar sign */
input[name="price"] {
    padding-left: 2rem;
}

/* Error styling */
input[type="text"].error, input[type="email"].error, input[type="number"].error, input[type="date"].error, textarea.error, select.error {
    border-color: #dc2626;
}

input[type="text"].error:focus, input[type="email"].error:focus, input[type="number"].error:focus, input[type="date"].error:focus, textarea.error:focus, select.error:focus {
    border-color: #dc2626;
    box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
}
</style>

<script>
// Real-time total calculation
function updatePreview() {
    const qty = parseFloat(document.getElementById('{{ form.qty.id_for_label }}').value) || 0;
    const price = parseFloat(document.getElementById('{{ form.price.id_for_label }}').value) || 0;
    const total = qty * price;
    
    document.getElementById('preview-qty').textContent = qty.toFixed(2);
    document.getElementById('preview-price').textContent = `$${price.toFixed(2)}`;
    document.getElementById('preview-total').textContent = `$${total.toFixed(2)}`;
}

// Add event listeners for real-time updates
document.getElementById('{{ form.qty.id_for_label }}').addEventListener('input', updatePreview);
document.getElementById('{{ form.price.id_for_label }}').addEventListener('input', updatePreview);

// Initialize preview on page load
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    
    // Focus on description field
    document.getElementById('{{ form.description.id_for_label }}').focus();
});

// Keyboard navigation: Enter to submit
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && e.target.tagName === 'INPUT') {
        e.preventDefault();
        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.click();
        }
    }
});
</script>
{% endblock %}

