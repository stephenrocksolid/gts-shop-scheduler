{% load static %}

<div class="day-cell {% if day.is_today %}today{% endif %} {% if day.is_other_month %}other-month{% endif %} {% if day.is_weekend %}weekend{% endif %}"
     data-date="{{ day.date|date:'Y-m-d' }}"
     data-day-number="{{ day.day_number }}"
     ondrop="handleJobDrop(event)"
     ondragover="handleDragOver(event)"
     ondragleave="handleDragLeave(event)">
    
    <!-- Day Header -->
    <div class="day-header">
        <span class="day-number">{{ day.day_number }}</span>
        
        <!-- Today Indicator -->
        {% if day.is_today %}
        <div class="today-indicator"></div>
        {% endif %}
        
        <!-- Event Count Badge -->
        {% if day.event_count > 0 %}
        <div class="event-count-badge">
            <span class="event-count">{{ day.event_count }}</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Day Events Container -->
    <div class="day-events-container">
        {% for event in day.events %}
        {% include "rental_scheduler/components/job_chip.html" with job=event %}
        {% endfor %}
        
        <!-- More Events Indicator -->
        {% if day.event_count > 3 %}
        <div class="more-events-indicator">
            <span class="more-events-text">+{{ day.event_count|add:"-3" }} more</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Quick Add Button -->
    <button class="quick-add-btn" 
            onclick="quickAddJob('{{ day.date|date:'Y-m-d' }}')"
            title="Add job for {{ day.date|date:'M j, Y' }}">
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
        </svg>
    </button>
    
    <!-- Day Summary (for mobile) -->
    <div class="day-summary">
        <div class="summary-stats">
            {% if day.completed_count > 0 %}
            <span class="stat completed">{{ day.completed_count }} done</span>
            {% endif %}
            {% if day.pending_count > 0 %}
            <span class="stat pending">{{ day.pending_count }} pending</span>
            {% endif %}
        </div>
    </div>
</div>

<style>
.day-cell {
    @apply relative min-h-[120px] p-2 border border-gray-200 bg-white;
    @apply hover:bg-gray-50 transition-colors duration-200;
    @apply cursor-pointer;
}

.day-cell.today {
    @apply bg-red-50 border-red-300;
}

.day-cell.today:hover {
    @apply bg-red-100;
}

.day-cell.other-month {
    @apply bg-gray-50 border-gray-100;
    @apply opacity-60;
}

.day-cell.weekend {
    @apply bg-gray-25;
}

.day-cell.weekend:hover {
    @apply bg-gray-100;
}

.day-header {
    @apply flex items-center justify-between mb-2;
    @apply relative;
}

.day-number {
    @apply text-sm font-medium text-gray-900;
}

.day-cell.today .day-number {
    @apply text-red-600 font-semibold;
}

.day-cell.other-month .day-number {
    @apply text-gray-400;
}

.today-indicator {
    @apply absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full;
}

.event-count-badge {
    @apply bg-red-100 text-red-800 text-xs font-medium px-1.5 py-0.5 rounded-full;
}

.day-events-container {
    @apply space-y-1 min-h-[60px];
}

.more-events-indicator {
    @apply text-xs text-gray-500 text-center py-1;
    @apply bg-gray-100 rounded;
    @apply cursor-pointer hover:bg-gray-200 transition-colors duration-200;
}

.quick-add-btn {
    @apply absolute bottom-1 right-1 p-1.5 text-gray-400 hover:text-red-600;
    @apply hover:bg-red-50 rounded transition-colors duration-200;
    @apply opacity-0 group-hover:opacity-100;
}

.day-cell:hover .quick-add-btn {
    @apply opacity-100;
}

.day-summary {
    @apply hidden;
}

.summary-stats {
    @apply flex flex-wrap gap-1 mt-1;
}

.stat {
    @apply text-xs px-1.5 py-0.5 rounded-full;
}

.stat.completed {
    @apply bg-green-100 text-green-800;
}

.stat.pending {
    @apply bg-yellow-100 text-yellow-800;
}

/* Drag and drop states */
.day-cell.drag-over {
    @apply bg-blue-100 border-blue-400;
    @apply ring-2 ring-blue-500 ring-opacity-50;
}

.day-cell.drag-over .day-number {
    @apply text-blue-600 font-semibold;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .day-cell {
        @apply min-h-[80px] p-1;
    }
    
    .day-number {
        @apply text-xs;
    }
    
    .day-events-container {
        @apply min-h-[40px] space-y-0.5;
    }
    
    .quick-add-btn {
        @apply p-1 opacity-100;
    }
    
    .day-summary {
        @apply block;
    }
    
    .summary-stats {
        @apply mt-0.5;
    }
    
    .stat {
        @apply text-xs px-1 py-0.5;
    }
}

@media (max-width: 640px) {
    .day-cell {
        @apply min-h-[60px];
    }
    
    .day-events-container {
        @apply min-h-[30px];
    }
    
    .event-count-badge {
        @apply hidden;
    }
    
    .more-events-indicator {
        @apply hidden;
    }
}

/* Print styles */
@media print {
    .day-cell {
        @apply border border-gray-300 bg-white;
        @apply min-h-[100px] p-2;
    }
    
    .day-cell.today {
        @apply bg-red-50 border-red-300;
    }
    
    .quick-add-btn {
        @apply hidden;
    }
    
    .day-summary {
        @apply hidden;
    }
}

/* Accessibility */
.day-cell:focus {
    @apply outline-none ring-2 ring-red-500 ring-offset-2;
}

.day-cell:focus-within {
    @apply ring-2 ring-red-500 ring-offset-2;
}
</style>

<script>
// Day cell interaction handlers
function quickAddJob(date) {
    event.stopPropagation();
    window.location.href = `{% url 'rental_scheduler:job_create' %}?date=${date}&next={% url 'rental_scheduler:calendar' %}`;
}

// Drag and drop handlers
function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('drag-over');
}

function handleDragLeave(event) {
    event.currentTarget.classList.remove('drag-over');
}

function handleJobDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('drag-over');
    
    const jobId = event.dataTransfer.getData('text/plain');
    const targetDate = event.currentTarget.dataset.date;
    
    if (jobId && targetDate) {
        rescheduleJob(jobId, targetDate);
    }
}

// Keyboard navigation
document.addEventListener('DOMContentLoaded', function() {
    const dayCells = document.querySelectorAll('.day-cell');
    
    dayCells.forEach(cell => {
        cell.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                const date = this.dataset.date;
                quickAddJob(date);
            }
        });
        
        // Make day cells focusable
        cell.setAttribute('tabindex', '0');
    });
});

// Click handler for day cell
document.addEventListener('DOMContentLoaded', function() {
    const dayCells = document.querySelectorAll('.day-cell');
    
    dayCells.forEach(cell => {
        cell.addEventListener('click', function(e) {
            // Don't trigger if clicking on a job chip or quick add button
            if (e.target.closest('.job-chip') || e.target.closest('.quick-add-btn')) {
                return;
            }
            
            const date = this.dataset.date;
            const dayNumber = this.dataset.dayNumber;
            
            // Show day detail view or quick add modal
            showDayDetail(date, dayNumber);
        });
    });
});

function showDayDetail(date, dayNumber) {
    // Implementation for showing day detail view
    console.log(`Showing details for ${date} (day ${dayNumber})`);
    
    // This could open a modal with the day's events or navigate to a day view
    // For now, we'll just open the quick add form
    quickAddJob(date);
}

// More events indicator click handler
document.addEventListener('DOMContentLoaded', function() {
    const moreEventsIndicators = document.querySelectorAll('.more-events-indicator');
    
    moreEventsIndicators.forEach(indicator => {
        indicator.addEventListener('click', function(e) {
            e.stopPropagation();
            const dayCell = this.closest('.day-cell');
            const date = dayCell.dataset.date;
            
            // Show all events for this day
            showAllDayEvents(date);
        });
    });
});

function showAllDayEvents(date) {
    // Implementation for showing all events for a specific day
    console.log(`Showing all events for ${date}`);
    
    // This could open a modal or navigate to a day view
    // For now, we'll just show a toast message
    if (window.layout && window.layout.showToast) {
        window.layout.showToast(`Showing all events for ${date}`, 'info');
    }
}
</script>



