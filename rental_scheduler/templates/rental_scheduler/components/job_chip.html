{% load static %}

<div class="job-chip job-{{ job.status|lower }} {% if job.is_completed %}job-completed{% endif %} {% if job.is_canceled %}job-canceled{% endif %}"
     data-job-id="{{ job.id }}"
     onclick="openQuickActions({{ job|safe }})"
     ondblclick="editJob({{ job.id }})"
     title="{{ job.title }} - {{ job.customer }} ({{ job.start_time|time:'g:i A' }})">
    
    <!-- Job Time -->
    <div class="job-time">{{ job.start_time|time:'g:i A' }}</div>
    
    <!-- Job Content -->
    <div class="job-content">
        <div class="job-title">{{ job.title|truncatechars:20 }}</div>
        <div class="job-customer">{{ job.customer|truncatechars:15 }}</div>
    </div>
    
    <!-- Job Status Indicator -->
    <div class="job-status-indicator">
        {% include "rental_scheduler/components/status_pill.html" with status=job.status %}
    </div>
    
    <!-- Calendar Color Indicator -->
    {% if job.calendar %}
    <div class="calendar-indicator" style="background-color: {{ job.calendar.color }};"></div>
    {% endif %}
    
    <!-- Completion Overlay -->
    {% if job.is_completed %}
    <div class="completion-overlay">
        <svg class="completion-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
        </svg>
    </div>
    {% endif %}
</div>

<style>
.job-chip {
    @apply relative p-2 rounded-md text-xs font-medium cursor-pointer transition-all duration-200 select-none;
    @apply border border-transparent hover:border-gray-300;
    @apply shadow-sm hover:shadow-md;
    @apply transform hover:scale-105;
    @apply overflow-hidden;
    min-height: 2.5rem;
}

.job-chip:hover {
    @apply z-10;
}

.job-time {
    @apply text-xs font-bold text-gray-700 mb-1;
    @apply opacity-90;
}

.job-content {
    @apply space-y-0.5;
}

.job-title {
    @apply font-semibold text-gray-900 leading-tight;
    line-height: 1.1;
}

.job-customer {
    @apply text-gray-600 leading-tight;
    line-height: 1.1;
}

.job-status-indicator {
    @apply absolute top-1 right-1;
}

.job-status-indicator .status-pill {
    @apply text-xs px-1 py-0.5;
}

.calendar-indicator {
    @apply absolute left-0 top-0 bottom-0 w-1;
}

/* Status-based styling */
.job-scheduled {
    @apply bg-blue-50 border-blue-200;
}

.job-scheduled:hover {
    @apply bg-blue-100 border-blue-300;
}

.job-inprogress {
    @apply bg-yellow-50 border-yellow-200;
}

.job-inprogress:hover {
    @apply bg-yellow-100 border-yellow-300;
}

.job-completed {
    @apply bg-green-50 border-green-200;
}

.job-completed:hover {
    @apply bg-green-100 border-green-300;
}

.job-canceled {
    @apply bg-red-50 border-red-200;
}

.job-canceled:hover {
    @apply bg-red-100 border-red-300;
}

/* Completion states */
.job-completed .job-title,
.job-completed .job-customer {
    @apply line-through opacity-70;
}

.job-canceled .job-title,
.job-canceled .job-customer {
    @apply line-through opacity-50;
}

.completion-overlay {
    @apply absolute inset-0 bg-green-100 bg-opacity-50 flex items-center justify-center;
    @apply pointer-events-none;
}

.completion-icon {
    @apply w-4 h-4 text-green-600;
}

/* All-day job styling */
.job-chip.all-day {
    @apply bg-opacity-80;
}

.job-chip.all-day .job-time {
    @apply hidden;
}

/* Multi-day job styling */
.job-chip.multi-day {
    @apply border-l-4;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .job-chip {
        @apply p-1.5 text-xs;
        min-height: 2rem;
    }
    
    .job-title {
        @apply text-xs;
    }
    
    .job-customer {
        @apply text-xs;
    }
    
    .job-status-indicator {
        @apply top-0.5 right-0.5;
    }
    
    .job-status-indicator .status-pill {
        @apply text-xs px-0.5 py-0;
    }
}

@media (max-width: 640px) {
    .job-chip {
        @apply p-1 text-xs;
        min-height: 1.5rem;
    }
    
    .job-time {
        @apply hidden;
    }
    
    .job-content {
        @apply space-y-0;
    }
    
    .job-title {
        @apply text-xs leading-tight;
    }
    
    .job-customer {
        @apply hidden;
    }
    
    .job-status-indicator {
        @apply hidden;
    }
}

/* Animation for new jobs */
.job-chip.new-job {
    animation: jobAppear 0.3s ease-out;
}

@keyframes jobAppear {
    from {
        opacity: 0;
        transform: scale(0.8) translateY(-10px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(0);
    }
}

/* Drag and drop styling */
.job-chip.dragging {
    @apply opacity-50 transform scale-95;
    @apply shadow-lg;
}

.job-chip.drag-over {
    @apply bg-blue-100 border-blue-400;
}

/* Focus states for accessibility */
.job-chip:focus {
    @apply outline-none ring-2 ring-red-500 ring-offset-2;
}

/* Print styles */
@media print {
    .job-chip {
        @apply border border-gray-300 shadow-none;
        @apply transform-none;
        @apply break-inside-avoid;
    }
    
    .job-chip:hover {
        @apply transform-none shadow-none;
    }
}
</style>

<script>
// Job chip interaction handlers
function editJob(jobId) {
    event.stopPropagation();
    window.location.href = `{% url 'rental_scheduler:job_update' 0 %}`.replace('/0/', `/${jobId}/`);
}

// Add drag and drop functionality
document.addEventListener('DOMContentLoaded', function() {
    const jobChips = document.querySelectorAll('.job-chip');
    
    jobChips.forEach(chip => {
        chip.addEventListener('dragstart', function(e) {
            this.classList.add('dragging');
            e.dataTransfer.setData('text/plain', this.dataset.jobId);
        });
        
        chip.addEventListener('dragend', function() {
            this.classList.remove('dragging');
        });
        
        chip.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });
        
        chip.addEventListener('dragleave', function() {
            this.classList.remove('drag-over');
        });
        
        chip.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            
            const jobId = e.dataTransfer.getData('text/plain');
            const targetDate = this.closest('.calendar-day').dataset.date;
            
            // Handle job rescheduling
            rescheduleJob(jobId, targetDate);
        });
    });
});

function rescheduleJob(jobId, newDate) {
    // Implementation for rescheduling jobs via drag and drop
    console.log(`Rescheduling job ${jobId} to ${newDate}`);
    
    // This would typically make an AJAX call to update the job date
    fetch(`{% url 'rental_scheduler:job_reschedule' %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': window.calendarConfig.csrfToken,
        },
        body: JSON.stringify({
            job_id: jobId,
            new_date: newDate
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (window.layout && window.layout.showToast) {
                window.layout.showToast('Job rescheduled successfully', 'success');
            }
            // Refresh calendar
            if (window.calendar && window.calendar.refetchEvents) {
                window.calendar.refetchEvents();
            }
        } else {
            if (window.layout && window.layout.showToast) {
                window.layout.showToast(data.error || 'Failed to reschedule job', 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error rescheduling job:', error);
        if (window.layout && window.layout.showToast) {
            window.layout.showToast('Network error occurred', 'error');
        }
    });
}
</script>


