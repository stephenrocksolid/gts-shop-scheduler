{% load static %}

<!-- Job Edit Form for Panel -->
<form 
    hx-post="{% url 'rental_scheduler:job_edit_panel' job.id %}"
    hx-target="#job-panel .panel-body"
    hx-swap="innerHTML"
    class="space-y-6">
    {% csrf_token %}
    
    <!-- Customer Information -->
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                </svg>
                Customer Information
            </h3>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.business_name.id_for_label }}">
                        Business Name *
                    </label>
                    {{ form.business_name }}
                    {% if form.business_name.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.business_name.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.contact_name.id_for_label }}">
                        Contact Name
                    </label>
                    {{ form.contact_name }}
                    {% if form.contact_name.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.contact_name.errors.0 }}</p>
                    {% endif %}
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.phone.id_for_label }}">
                        Phone
                    </label>
                    {{ form.phone }}
                    {% if form.phone.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.phone.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Address Information -->
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
                Address Information
            </h3>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.address_line1.id_for_label }}">
                        Address Line 1
                    </label>
                    {{ form.address_line1 }}
                    {% if form.address_line1.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.address_line1.errors.0 }}</p>
                    {% endif %}
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.address_line2.id_for_label }}">
                        Address Line 2
                    </label>
                    {{ form.address_line2 }}
                    {% if form.address_line2.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.address_line2.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.city.id_for_label }}">
                        City
                    </label>
                    {{ form.city }}
                    {% if form.city.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.city.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.state.id_for_label }}">
                        State
                    </label>
                    {{ form.state }}
                    {% if form.state.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.state.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.postal_code.id_for_label }}">
                        ZIP Code
                    </label>
                    {{ form.postal_code }}
                    {% if form.postal_code.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.postal_code.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Trailer Information -->
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                    <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z"></path>
                </svg>
                Trailer Information
            </h3>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.trailer_color.id_for_label }}">
                        Color
                    </label>
                    {{ form.trailer_color }}
                    {% if form.trailer_color.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.trailer_color.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.trailer_serial.id_for_label }}">
                        Serial Number
                    </label>
                    {{ form.trailer_serial }}
                    {% if form.trailer_serial.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.trailer_serial.errors.0 }}</p>
                    {% endif %}
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.trailer_details.id_for_label }}">
                        Details
                    </label>
                    {{ form.trailer_details }}
                    {% if form.trailer_details.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.trailer_details.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Information -->
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
                Schedule Information
            </h3>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.start_dt.id_for_label }}">
                        Start Date & Time *
                    </label>
                    {{ form.start_dt }}
                    {% if form.start_dt.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.start_dt.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.end_dt.id_for_label }}">
                        End Date & Time *
                    </label>
                    {{ form.end_dt }}
                    {% if form.end_dt.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.end_dt.errors.0 }}</p>
                    {% endif %}
                </div>
                <div class="md:col-span-2">
                    <div class="flex items-center">
                        {{ form.all_day }}
                        <label class="ml-2 text-sm font-semibold text-gray-700" for="{{ form.all_day.id_for_label }}">
                            All Day Event
                        </label>
                    </div>
                    {% if form.all_day.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.all_day.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.status.id_for_label }}">
                        Status
                    </label>
                    {{ form.status }}
                    {% if form.status.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.status.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.quote.id_for_label }}">
                        Quote Amount
                    </label>
                    {{ form.quote }}
                    {% if form.quote.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.quote.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Notes -->
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                </svg>
                Notes
            </h3>
        </div>
        <div class="p-4">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.notes.id_for_label }}">
                        General Notes
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.notes.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2" for="{{ form.repair_notes.id_for_label }}">
                        Repair Notes
                    </label>
                    {{ form.repair_notes }}
                    {% if form.repair_notes.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ form.repair_notes.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
        <button 
            type="button"
            hx-get="{% url 'rental_scheduler:job_detail_panel' job.id %}"
            hx-target="#job-panel .panel-body"
            hx-swap="innerHTML"
            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm">
            Cancel
        </button>
        {% if job.status == 'uncompleted' %}
            <button 
                type="button"
                onclick="updateJobStatus({{ job.id }}, 'completed')"
                class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors text-sm">
                Mark as Complete
            </button>
        {% endif %}
        <button 
            type="submit"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm">
            Save Changes
        </button>
    </div>
</form>

<script>
// Function to toggle time inputs based on all_day checkbox
function toggleTimeInputs(checkbox) {
    const startInput = document.querySelector('input[name="start_dt"]');
    const endInput = document.querySelector('input[name="end_dt"]');
    
    if (checkbox.checked) {
        // If all day is checked, we could disable time inputs or set them to specific times
        // For now, we'll just add a visual indicator
        if (startInput) startInput.style.opacity = '0.6';
        if (endInput) endInput.style.opacity = '0.6';
    } else {
        if (startInput) startInput.style.opacity = '1';
        if (endInput) endInput.style.opacity = '1';
    }
}

// Job status update function for panel
function updateJobStatus(jobId, status) {
    if (confirm(`Are you sure you want to mark this job as ${status}?`)) {
        // Get CSRF token from cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        fetch(`/rental_scheduler/api/jobs/${jobId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                status: status
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                if (window.layout && window.layout.showToast) {
                    window.layout.showToast('Job status updated successfully!', 'success');
                } else {
                    alert('Job status updated successfully!');
                }
                // Close panel and refresh calendar
                if (window.JobPanel) {
                    window.JobPanel.close();
                }
                // Refresh the calendar if it exists
                if (typeof window.refreshCalendar === 'function') {
                    window.refreshCalendar();
                } else if (window.calendar && window.calendar.refetchEvents) {
                    window.calendar.refetchEvents();
                }
            } else {
                alert(data.error || 'Failed to update status');
            }
        })
        .catch(error => {
            console.error('Error updating job status:', error);
            alert('Network error occurred');
        });
    }
}
</script>
