{% load static %}

<!-- Job Details Content for Panel -->
<div class="space-y-6">
    
    <!-- Customer Information -->
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                </svg>
                Customer Information
            </h3>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% if job.business_name %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">Business Name</div>
                    <div class="text-sm text-gray-600">{{ job.business_name }}</div>
                </div>
                {% endif %}
                {% if job.contact_name %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">Contact Name</div>
                    <div class="text-sm text-gray-600">{{ job.contact_name }}</div>
                </div>
                {% endif %}
                {% if job.phone %}
                <div class="md:col-span-2">
                    <div class="text-sm font-semibold text-gray-700 mb-1 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
                        </svg>
                        Phone
                    </div>
                    <div class="text-sm text-gray-600">
                        <a href="tel:{{ job.phone|floatformat:0 }}" class="text-blue-600 hover:text-blue-800">{{ job.phone }}</a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Address Information -->
    {% if job.address_line1 or job.address_line2 or job.city or job.state or job.postal_code %}
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                </svg>
                Address Information
            </h3>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% if job.address_line1 %}
                <div class="md:col-span-2">
                    <div class="text-sm font-semibold text-gray-700 mb-1">Address Line 1</div>
                    <div class="text-sm text-gray-600">{{ job.address_line1 }}</div>
                </div>
                {% endif %}
                {% if job.address_line2 %}
                <div class="md:col-span-2">
                    <div class="text-sm font-semibold text-gray-700 mb-1">Address Line 2</div>
                    <div class="text-sm text-gray-600">{{ job.address_line2 }}</div>
                </div>
                {% endif %}
                {% if job.city %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">City</div>
                    <div class="text-sm text-gray-600">{{ job.city }}</div>
                </div>
                {% endif %}
                {% if job.state %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">State</div>
                    <div class="text-sm text-gray-600">{{ job.state }}</div>
                </div>
                {% endif %}
                {% if job.postal_code %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">ZIP Code</div>
                    <div class="text-sm text-gray-600">{{ job.postal_code }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Trailer Information -->
    {% if job.trailer_color or job.trailer_serial or job.trailer_details %}
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"></path>
                    <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1V8a1 1 0 00-1-1h-3z"></path>
                </svg>
                Trailer Information
            </h3>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% if job.trailer_color %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">Color</div>
                    <div class="text-sm text-gray-600">{{ job.trailer_color }}</div>
                </div>
                {% endif %}
                {% if job.trailer_serial %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">Serial Number</div>
                    <div class="text-sm text-gray-600">{{ job.trailer_serial }}</div>
                </div>
                {% endif %}
                {% if job.trailer_details %}
                <div class="md:col-span-2">
                    <div class="text-sm font-semibold text-gray-700 mb-1">Details</div>
                    <div class="text-sm text-gray-600">{{ job.trailer_details }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Schedule Information -->
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
                Schedule Information
            </h3>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">Start Date & Time</div>
                    <div class="text-sm text-gray-600">{{ job.start_dt|date:"M j, Y g:i A" }}</div>
                </div>
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">End Date & Time</div>
                    <div class="text-sm text-gray-600">{{ job.end_dt|date:"M j, Y g:i A" }}</div>
                </div>
                <div class="md:col-span-2">
                    <div class="text-sm font-semibold text-gray-700 mb-1">All Day Event</div>
                    <div class="text-sm text-gray-600">{{ job.all_day|yesno:"Yes,No" }}</div>
                </div>
                {% if job.calendar %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">Calendar</div>
                    <div class="text-sm text-gray-600">{{ job.calendar }}</div>
                </div>
                {% endif %}
                {% if job.status %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">Status</div>
                    <div class="text-sm text-gray-600">{{ job.get_status_display }}</div>
                </div>
                {% endif %}
                {% if job.quote %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-1">Quote Amount</div>
                    <div class="text-sm text-gray-600">${{ job.quote|floatformat:2 }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Notes -->
    {% if job.notes or job.repair_notes %}
    <div class="bg-gray-50 rounded-xl border border-gray-200 overflow-hidden">
        <div class="bg-gray-200 px-4 py-3 border-b border-gray-300">
            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="w-5 h-5 mr-3 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"></path>
                </svg>
                Notes
            </h3>
        </div>
        <div class="p-4">
            <div class="space-y-4">
                {% if job.notes %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-2">General Notes</div>
                    <div class="text-sm text-gray-600 whitespace-pre-wrap">{{ job.notes }}</div>
                </div>
                {% endif %}
                {% if job.repair_notes %}
                <div>
                    <div class="text-sm font-semibold text-gray-700 mb-2">Repair Notes</div>
                    <div class="text-sm text-gray-600 whitespace-pre-wrap">{{ job.repair_notes }}</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="flex justify-end gap-3 pt-4 border-t border-gray-200">
        <button 
            type="button"
            onclick="JobPanel.close()"
            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 font-medium hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm">
            Close
        </button>
        {% if job.status == 'uncompleted' %}
            <button 
                type="button"
                onclick="updateJobStatus({{ job.id }}, 'completed')"
                class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors text-sm">
                Mark as Complete
            </button>
        {% endif %}
        <button 
            hx-get="{% url 'rental_scheduler:job_edit_panel' job.id %}"
            hx-target="#job-panel .panel-body"
            hx-swap="innerHTML"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors text-sm">
            Edit Job
        </button>
    </div>
</div>

<script>
// Job status update function for panel
function updateJobStatus(jobId, status) {
    if (confirm(`Are you sure you want to mark this job as ${status}?`)) {
        // Get CSRF token from cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        fetch(`/rental_scheduler/api/jobs/${jobId}/update-status/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                status: status
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                if (window.layout && window.layout.showToast) {
                    window.layout.showToast('Job status updated successfully!', 'success');
                } else {
                    alert('Job status updated successfully!');
                }
                // Close panel and refresh calendar
                if (window.JobPanel) {
                    window.JobPanel.close();
                }
                // Refresh the calendar if it exists
                if (typeof window.refreshCalendar === 'function') {
                    window.refreshCalendar();
                } else if (window.calendar && window.calendar.refetchEvents) {
                    window.calendar.refetchEvents();
                }
            } else {
                alert(data.error || 'Failed to update status');
            }
        })
        .catch(error => {
            console.error('Error updating job status:', error);
            alert('Network error occurred');
        });
    }
}
</script>
