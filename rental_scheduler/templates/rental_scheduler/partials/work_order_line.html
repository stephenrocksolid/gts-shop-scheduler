<tr class="hover:bg-gray-50 transition-colors duration-150" id="line-row-{{ line.id }}" data-line-id="{{ line.id }}">
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        <span class="font-mono text-gray-600">{{ line.item_code|default:"-" }}</span>
    </td>
    <td class="px-6 py-4 text-sm text-gray-900">
        <div class="max-w-xs">
            <span class="font-medium">{{ line.description }}</span>
        </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        <span class="font-mono">{{ line.qty|floatformat:2 }}</span>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        <span class="font-mono">${{ line.rate|floatformat:2 }}</span>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
        <span class="font-mono text-blue-600">${{ line.total|floatformat:2 }}</span>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
        <div class="flex space-x-2">
            <button onclick="editLine({{ line.id }})" 
                    class="text-indigo-600 hover:text-indigo-900 transition-colors duration-150"
                    title="Edit line item">
                <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteLine({{ line.id }})" 
                    class="text-red-600 hover:text-red-900 transition-colors duration-150"
                    title="Delete line item">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </td>
</tr>

<!-- Edit Form Row (Hidden by default) -->
<tr id="edit-form-{{ line.id }}" class="hidden bg-blue-50 border-l-4 border-blue-400">
    <td colspan="6" class="px-6 py-4">
        <div class="bg-white border border-gray-300 rounded-lg p-4 shadow-sm">
            <div class="flex justify-between items-center mb-3">
                <h4 class="text-lg font-medium text-gray-900">Edit Line Item</h4>
                <button onclick="cancelEdit({{ line.id }})" 
                        class="text-gray-400 hover:text-gray-600 transition-colors duration-150">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="edit-line-form-{{ line.id }}" class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div>
                    <label for="edit-item_code-{{ line.id }}" class="block text-sm font-medium text-gray-700 mb-1">Item Code</label>
                    <input type="text" id="edit-item_code-{{ line.id }}" name="item_code" value="{{ line.item_code|default:'' }}"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Part #">
                </div>
                <div class="md:col-span-2">
                    <label for="edit-description-{{ line.id }}" class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                    <input type="text" id="edit-description-{{ line.id }}" name="description" value="{{ line.description }}" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="Description of work or item">
                </div>
                <div>
                    <label for="edit-qty-{{ line.id }}" class="block text-sm font-medium text-gray-700 mb-1">Qty</label>
                    <input type="number" id="edit-qty-{{ line.id }}" name="qty" value="{{ line.qty }}" step="0.01" min="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onchange="calculateEditLineTotal({{ line.id }})">
                </div>
                <div>
                    <label for="edit-rate-{{ line.id }}" class="block text-sm font-medium text-gray-700 mb-1">Rate</label>
                    <input type="number" id="edit-rate-{{ line.id }}" name="rate" value="{{ line.rate }}" step="0.01" min="0"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           onchange="calculateEditLineTotal({{ line.id }})">
                </div>
                <div class="md:col-span-3 flex space-x-3">
                    <button type="submit" 
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        <i class="fas fa-save mr-2"></i>Update Line Item
                    </button>
                    <button type="button" onclick="cancelEdit({{ line.id }})"
                            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                        Cancel
                    </button>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Line Total</label>
                    <div id="edit-line-total-{{ line.id }}" class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md text-gray-900 font-medium">
                        ${{ line.total|floatformat:2 }}
                    </div>
                </div>
            </form>
        </div>
    </td>
</tr>

<script>
// Line management functions
async function editLine(lineId) {
    // Hide all other edit forms first
    document.querySelectorAll('[id^="edit-form-"]').forEach(form => {
        form.classList.add('hidden');
    });
    
    // Show this edit form
    const editForm = document.getElementById(`edit-form-${lineId}`);
    editForm.classList.remove('hidden');
    
    // Focus on description field
    document.getElementById(`edit-description-${lineId}`).focus();
    
    // Setup form submission
    const form = document.getElementById(`edit-line-form-${lineId}`);
    form.onsubmit = (e) => handleEditSubmit(e, lineId);
    
    // Setup real-time total calculation
    const qtyInput = document.getElementById(`edit-qty-${lineId}`);
    const rateInput = document.getElementById(`edit-rate-${lineId}`);
    if (qtyInput && rateInput) {
        qtyInput.addEventListener('input', () => calculateEditLineTotal(lineId));
        rateInput.addEventListener('input', () => calculateEditLineTotal(lineId));
    }
}

function calculateEditLineTotal(lineId) {
    const qty = parseFloat(document.getElementById(`edit-qty-${lineId}`).value) || 0;
    const rate = parseFloat(document.getElementById(`edit-rate-${lineId}`).value) || 0;
    const total = qty * rate;
    document.getElementById(`edit-line-total-${lineId}`).textContent = `$${total.toFixed(2)}`;
}

async function handleEditSubmit(e, lineId) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        item_code: formData.get('item_code'),
        description: formData.get('description'),
        qty: formData.get('qty'),
        rate: formData.get('rate')
    };
    
    try {
        const response = await fetch(`/rental_scheduler/api/workorderlines/${lineId}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: new URLSearchParams(data)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Replace the line row with updated HTML
            const lineRow = document.getElementById(`line-row-${lineId}`);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = result.line_html;
            const newRow = tempDiv.querySelector(`[data-line-id="${lineId}"]`);
            
            if (newRow) {
                lineRow.outerHTML = result.line_html;
            }
            
            // Update totals
            document.getElementById('total-amount').textContent = `$${parseFloat(result.total_amount).toFixed(2)}`;
            
            // Hide edit form
            cancelEdit(lineId);
            
            // Show success message
            showToast('success', result.message);
        } else {
            showToast('error', result.error);
        }
    } catch (error) {
        showToast('error', 'Failed to update line item');
    }
}

function cancelEdit(lineId) {
    document.getElementById(`edit-form-${lineId}`).classList.add('hidden');
}

async function deleteLine(lineId) {
    if (!confirm('Are you sure you want to delete this line item? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/rental_scheduler/api/workorderlines/${lineId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            // Remove the line row
            const lineRow = document.getElementById(`line-row-${lineId}`);
            const editForm = document.getElementById(`edit-form-${lineId}`);
            
            if (lineRow) lineRow.remove();
            if (editForm) editForm.remove();
            
            // Update totals
            document.getElementById('total-amount').textContent = `$${parseFloat(result.total_amount).toFixed(2)}`;
            
            // Check if table is empty
            const tbody = document.getElementById('lines-table-body');
            if (tbody.children.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <div class="flex flex-col items-center py-8">
                                <i class="fas fa-tools text-4xl text-gray-300 mb-4"></i>
                                <p class="text-lg font-medium text-gray-500">No line items yet</p>
                                <p class="text-sm text-gray-400">Click "Add Line Item" to get started</p>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            showToast('success', result.message);
        } else {
            showToast('error', result.error);
        }
    } catch (error) {
        showToast('error', 'Failed to delete line item');
    }
}

function showToast(type, message) {
    const toastContainer = document.getElementById('toast-container');
    if (!toastContainer) return;
    
    const toast = document.createElement('div');
    const borderColor = type === 'success' ? 'border-green-500' : 'border-red-500';
    const textColor = type === 'success' ? 'text-green-700' : 'text-red-700';
    const icon = type === 'success' ? 'fas fa-check' : 'fas fa-exclamation-triangle';
    
    toast.className = `toast ${borderColor} bg-white border-l-4 p-4 shadow-lg rounded mb-2 max-w-sm transform transition-all duration-300 ease-in-out`;
    
    toast.innerHTML = `
        <div class="flex items-center">
            <div class="flex-shrink-0">
                <i class="${icon} ${textColor}"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm font-medium ${textColor}">${message}</p>
            </div>
            <div class="ml-auto pl-3">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                        class="text-gray-400 hover:text-gray-600 transition-colors duration-150">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
        toast.style.opacity = '1';
    }, 10);
    
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.transform = 'translateX(100%)';
            toast.style.opacity = '0';
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 300);
        }
    }, 5000);
}
</script>
