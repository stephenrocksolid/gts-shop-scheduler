{% load static %}
{# Expanded occurrence rows for a recurring series #}
{# Contains both materialized jobs and virtual occurrences #}

{% for job in materialized_jobs %}
<tr class="hover:bg-gray-50 job-row series-occurrence-row bg-gray-50/50"
    id="job-row-{{ job.id }}"
    data-job-id="{{ job.id }}"
    data-series-id="{{ parent_id }}"
    data-series-scope="{{ scope }}">
    <td class="px-6 py-4 whitespace-nowrap text-center">
        <div class="flex items-center justify-center">
            <span class="text-gray-400 mr-2 text-xs">└</span>
            <div>
                <div class="text-sm font-medium text-gray-900">{{ job.display_name }}</div>
                {% if job.get_phone %}
                    <div class="text-sm text-gray-500">{{ job.get_phone }}</div>
                {% endif %}
            </div>
        </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
              style="background-color: {{ job.calendar.color }}20; color: {{ job.calendar.color }};">
            {{ job.calendar.name }}
        </span>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-center">
        <div class="flex items-center justify-center space-x-2">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                {% if job.status == 'uncompleted' %}bg-yellow-100 text-yellow-800
                {% elif job.status == 'completed' %}bg-green-100 text-green-800{% endif %}">
                {{ job.get_status_display }}
            </span>
            {% if job.is_overdue %}
                <span class="text-red-600 text-xs">⚠️ OVERDUE</span>
            {% endif %}
        </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        {{ job.start_dt|date:"M j, Y" }}
        {% if not job.all_day %}
            <br><span class="text-gray-500">{{ job.start_dt|time:"g:i A" }}</span>
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        {{ job.end_dt|date:"M j, Y" }}
        {% if not job.all_day %}
            <br><span class="text-gray-500">{{ job.end_dt|time:"g:i A" }}</span>
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
        {% if job.is_recurring_parent %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                Series Template
            </span>
        {% elif job.is_recurring_instance %}
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                ↻ Instance
            </span>
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center">
        <div class="flex justify-center space-x-3">
            <button type="button"
                    onclick="event.stopPropagation(); JobPanel.setTitle('Edit Job'); JobPanel.load('{% url 'rental_scheduler:job_create_partial' %}?edit={{ job.pk }}');"
                    class="text-green-600 hover:text-green-900 transition-colors cursor-pointer"
                    title="Edit Job">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
            </button>
            <a href="{% url 'rental_scheduler:job_delete' job.pk %}"
               class="text-red-600 hover:text-red-900 transition-colors cursor-pointer"
               title="Delete Job">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </a>
        </div>
    </td>
</tr>
{% endfor %}

{% for occ in virtual_occurrences %}
<tr class="hover:bg-gray-50 job-row series-occurrence-row virtual-occurrence-row bg-indigo-50/30"
    data-virtual="1"
    data-recurrence-parent-id="{{ parent_id }}"
    data-recurrence-original-start="{{ occ.start_dt|date:'c' }}"
    data-series-id="{{ parent_id }}"
    data-series-scope="{{ scope }}">
    <td class="px-6 py-4 whitespace-nowrap text-center">
        <div class="flex items-center justify-center">
            <span class="text-indigo-400 mr-2" title="Virtual occurrence (click to open)">↻</span>
            <div>
                <div class="text-sm font-medium text-gray-900">{{ parent.display_name }}</div>
                {% if parent.get_phone %}
                    <div class="text-sm text-gray-500">{{ parent.get_phone }}</div>
                {% endif %}
            </div>
        </div>
    </td>
    <td class="px-6 py-4 whitespace-nowrap">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
              style="background-color: {{ parent.calendar.color }}20; color: {{ parent.calendar.color }};">
            {{ parent.calendar.name }}
        </span>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-center">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500">
            Virtual
        </span>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        {{ occ.start_dt|date:"M j, Y" }}
        {% if not parent.all_day %}
            <br><span class="text-gray-500">{{ occ.start_dt|time:"g:i A" }}</span>
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
        {{ occ.end_dt|date:"M j, Y" }}
        {% if not parent.all_day %}
            <br><span class="text-gray-500">{{ occ.end_dt|time:"g:i A" }}</span>
        {% endif %}
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-center">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-600">
            #{{ occ.occurrence_number }}
        </span>
    </td>
    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-center">
        <span class="text-indigo-600 text-xs">Click to open</span>
    </td>
</tr>
{% empty %}
{% if not materialized_jobs %}
<tr class="series-occurrence-row" data-series-id="{{ parent_id }}" data-series-scope="{{ scope }}">
    <td colspan="7" class="px-6 py-4 text-center text-gray-500 text-sm">
        No matching occurrences found.
    </td>
</tr>
{% endif %}
{% endfor %}

{% if has_more %}
<tr class="series-occurrence-row show-more-row bg-gray-50"
    data-series-id="{{ parent_id }}"
    data-series-scope="{{ scope }}">
    <td colspan="7" class="px-6 py-3 text-center">
        <button type="button"
                class="show-more-series-btn text-indigo-600 hover:text-indigo-800 text-sm font-medium"
                data-parent-id="{{ parent_id }}"
                data-scope="{{ scope }}"
                data-current-offset="{{ offset }}"
                data-search="{{ search_query|urlencode }}">
            Show more occurrences...
        </button>
    </td>
</tr>
{% endif %}

