{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - GTS Scheduler{% endblock %}

{% block extra_css %}
<style>
    .search-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .search-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .search-input-container {
        position: relative;
        max-width: 600px;
        margin: 0 auto 2rem;
    }
    
    .search-input {
        width: 100%;
        padding: 1rem 1.5rem;
        font-size: 1.125rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.75rem;
        background: white;
        transition: all 0.2s ease;
    }
    
    .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .search-icon {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }
    
    .search-shortcuts {
        text-align: center;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .shortcut-key {
        background: #f3f4f6;
        border: 1px solid #d1d5db;
        border-radius: 0.25rem;
        padding: 0.125rem 0.375rem;
        font-family: monospace;
        font-size: 0.75rem;
    }
    
    .facets-container {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .facet-button {
        padding: 0.5rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background: white;
        color: #374151;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .facet-button:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }
    
    .facet-button.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }
    
    .facet-count {
        background: #e5e7eb;
        color: #374151;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 500;
    }
    
    .facet-button.active .facet-count {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }
    
    .results-container {
        min-height: 400px;
    }
    
    .results-section {
        margin-bottom: 2rem;
    }
    
    .results-section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .result-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
    }
    
    .result-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .result-card.selected {
        border-color: #10b981;
        background: #f0fdf4;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .result-title {
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.5rem;
    }
    
    .result-subtitle {
        color: #6b7280;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }
    
    .result-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: #9ca3af;
    }
    
    .result-meta-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .result-actions {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        display: none;
    }
    
    .result-card:hover .result-actions {
        display: block;
    }
    
    .action-button {
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.25rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        cursor: pointer;
        margin-left: 0.25rem;
        transition: background 0.2s ease;
    }
    
    .action-button:hover {
        background: #2563eb;
    }
    
    .action-button.secondary {
        background: #6b7280;
    }
    
    .action-button.secondary:hover {
        background: #4b5563;
    }
    
    .no-results {
        text-align: center;
        color: #6b7280;
        padding: 3rem 1rem;
    }
    
    .loading {
        text-align: center;
        color: #6b7280;
        padding: 2rem;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid #e5e7eb;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .search-tips {
        background: #f0f9ff;
        border: 1px solid #0ea5e9;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 2rem;
        text-align: center;
    }
    
    .search-tips h3 {
        color: #0c4a6e;
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    .search-tips p {
        color: #0369a1;
        font-size: 0.875rem;
        margin: 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="search-container">
    <div class="search-header">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Global Search</h1>
        <p class="text-gray-600">Search across customers, trailers, and jobs</p>
    </div>
    
    <!-- Search Tips -->
    <div class="search-tips">
        <h3>ðŸ’¡ Search Tips</h3>
        <p>Use <span class="shortcut-key">Tab</span> to navigate between results, <span class="shortcut-key">Enter</span> to select, and <span class="shortcut-key">Esc</span> to clear</p>
    </div>
    
    <!-- Search Input -->
    <div class="search-input-container">
        <input 
            type="text" 
            id="search-input"
            class="search-input"
            placeholder="Search for customers, trailers, phone numbers, addresses..."
            value="{{ query }}"
            hx-get="{% url 'rental_scheduler:search_results_partial' %}"
            hx-trigger="keyup changed delay:300ms"
            hx-target="#search-results"
            hx-indicator="#loading-indicator"
            hx-include="[name='facet']"
            autocomplete="off"
            spellcheck="false"
        >
        <svg class="search-icon w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
    </div>
    
    <!-- Keyboard Shortcuts -->
    <div class="search-shortcuts">
        <span class="shortcut-key">Tab</span> Navigate â€¢ <span class="shortcut-key">Enter</span> Select â€¢ <span class="shortcut-key">Esc</span> Clear
    </div>
    
    <!-- Facet Buttons -->
    <div class="facets-container" id="facets-container">
        {% for facet in facets %}
        <button 
            class="facet-button {% if facet.value == current_facet %}active{% endif %}"
            data-facet="{{ facet.value }}"
            hx-get="{% url 'rental_scheduler:search_results_partial' %}"
            hx-trigger="click"
            hx-target="#search-results"
            hx-include="#search-input"
            hx-vals='{"facet": "{{ facet.value }}"}'
            hx-indicator="#loading-indicator"
        >
            {{ facet.label }}
            <span class="facet-count" id="count-{{ facet.value }}">{{ facet.count }}</span>
        </button>
        {% endfor %}
    </div>
    
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading" style="display: none;">
        <div class="loading-spinner"></div>
        Searching...
    </div>
    
    <!-- Search Results -->
    <div id="search-results" class="results-container">
        {% if query %}
            {% include 'rental_scheduler/search_results_partial.html' %}
        {% else %}
            <div class="no-results">
                <svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <p class="text-lg font-medium">Enter a search term to begin</p>
                <p class="text-sm">Search across customers, trailers, phone numbers, and addresses</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Hidden form for facet tracking -->
<form id="facet-form" style="display: none;">
    <input type="hidden" name="facet" value="{{ current_facet }}">
</form>

<!-- Form Pre-fill Modal -->
<div id="prefill-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Pre-fill Form</h3>
                <p class="text-sm text-gray-600">Select which form to pre-fill with this data</p>
            </div>
            <div class="px-6 py-4 space-y-3">
                <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                        onclick="prefillForm('job')">
                    <div class="font-medium text-gray-900">New Job</div>
                    <div class="text-sm text-gray-600">Create a new job with this customer/trailer</div>
                </button>
                <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                        onclick="prefillForm('contract')">
                    <div class="font-medium text-gray-900">New Contract</div>
                    <div class="text-sm text-gray-600">Create a new rental contract</div>
                </button>
                <button class="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                        onclick="prefillForm('workorder')">
                    <div class="font-medium text-gray-900">New Work Order</div>
                    <div class="text-sm text-gray-600">Create a new work order</div>
                </button>
            </div>
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button onclick="closePrefillModal()" 
                        class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class SearchManager {
    constructor() {
        this.searchInput = document.getElementById('search-input');
        this.facetButtons = document.querySelectorAll('.facet-button');
        this.resultsContainer = document.getElementById('search-results');
        this.selectedIndex = -1;
        this.currentResults = [];
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        // Update facet counts when search results change
        this.searchInput.addEventListener('input', () => {
            setTimeout(() => this.updateFacetCounts(), 300);
        });
        
        // Handle facet button clicks
        this.facetButtons.forEach(button => {
            button.addEventListener('click', () => {
                this.facetButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                document.querySelector('input[name="facet"]').value = button.dataset.facet;
            });
        });
        
        // Handle keyboard navigation
        this.searchInput.addEventListener('keydown', (e) => this.handleKeydown(e));
        
        // Handle result card clicks
        this.resultsContainer.addEventListener('click', (e) => this.handleResultClick(e));
        
        // Focus search input on page load
        this.searchInput.focus();
    }
    
    handleKeydown(e) {
        switch(e.key) {
            case 'Tab':
                e.preventDefault();
                this.navigateResults(e.shiftKey ? -1 : 1);
                break;
            case 'Enter':
                e.preventDefault();
                this.selectCurrentResult();
                break;
            case 'Escape':
                e.preventDefault();
                this.clearSearch();
                break;
            case 'ArrowDown':
                e.preventDefault();
                this.navigateResults(1);
                break;
            case 'ArrowUp':
                e.preventDefault();
                this.navigateResults(-1);
                break;
        }
    }
    
    navigateResults(direction) {
        const resultCards = this.resultsContainer.querySelectorAll('.result-card');
        if (resultCards.length === 0) return;
        
        // Remove previous selection
        if (this.selectedIndex >= 0 && this.selectedIndex < resultCards.length) {
            resultCards[this.selectedIndex].classList.remove('selected');
        }
        
        // Calculate new index
        this.selectedIndex += direction;
        if (this.selectedIndex < 0) this.selectedIndex = resultCards.length - 1;
        if (this.selectedIndex >= resultCards.length) this.selectedIndex = 0;
        
        // Select new result
        resultCards[this.selectedIndex].classList.add('selected');
        resultCards[this.selectedIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    
    selectCurrentResult() {
        const resultCards = this.resultsContainer.querySelectorAll('.result-card');
        if (this.selectedIndex >= 0 && this.selectedIndex < resultCards.length) {
            const selectedCard = resultCards[this.selectedIndex];
            const url = selectedCard.dataset.url;
            if (url) {
                this.showPrefillModal(selectedCard);
            }
        }
    }
    
    showPrefillModal(resultCard) {
        const modal = document.getElementById('prefill-modal');
        modal.classList.remove('hidden');
        modal.dataset.resultCard = resultCard.outerHTML;
        modal.dataset.resultUrl = resultCard.dataset.url;
    }
    
    clearSearch() {
        this.searchInput.value = '';
        this.searchInput.dispatchEvent(new Event('input'));
        this.selectedIndex = -1;
        this.searchInput.focus();
    }
    
    handleResultClick(e) {
        const resultCard = e.target.closest('.result-card');
        if (resultCard) {
            this.showPrefillModal(resultCard);
        }
    }
    
    updateFacetCounts() {
        const query = this.searchInput.value.trim();
        if (!query) return;
        
        fetch(`{% url 'rental_scheduler:search_facet_counts' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                Object.keys(data).forEach(facet => {
                    const countElement = document.getElementById(`count-${facet}`);
                    if (countElement) {
                        countElement.textContent = data[facet];
                    }
                });
            });
    }
}

// Global functions for form pre-filling
function prefillForm(formType) {
    const modal = document.getElementById('prefill-modal');
    const resultUrl = modal.dataset.resultUrl;
    
    if (resultUrl) {
        // Add form type parameter and redirect
        const separator = resultUrl.includes('?') ? '&' : '?';
        const prefillUrl = `${resultUrl}${separator}prefill_type=${formType}`;
        window.location.href = prefillUrl;
    }
    
    closePrefillModal();
}

function closePrefillModal() {
    const modal = document.getElementById('prefill-modal');
    modal.classList.add('hidden');
    delete modal.dataset.resultCard;
    delete modal.dataset.resultUrl;
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new SearchManager();
});

// Close modal when clicking outside
document.addEventListener('click', (e) => {
    const modal = document.getElementById('prefill-modal');
    if (e.target === modal) {
        closePrefillModal();
    }
});
</script>
{% endblock %}
