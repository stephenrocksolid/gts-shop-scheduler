{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link href="{% static 'rental_scheduler/css/calendar.css' %}" rel="stylesheet">
<link href="{% static 'rental_scheduler/css/job_calendar.css' %}" rel="stylesheet">

<!-- Alpine.js Component Definitions -->
<script>
// Define Alpine.js components immediately and ensure they're available globally
(function() {
    'use strict';
    
    // Define the components
    function quickActionsModal() {
        return {
            isOpen: false,
            currentJob: null,
            
            open(jobData) {
                this.currentJob = jobData;
                this.isOpen = true;
                this.updateModalContent();
            },
            
            close() {
                this.isOpen = false;
                this.currentJob = null;
            },
            
            updateModalContent() {
                if (this.currentJob) {
                    const titleEl = document.getElementById('modal-job-title');
                    const detailsEl = document.getElementById('modal-job-details');
                    if (titleEl) titleEl.textContent = this.currentJob.title;
                    if (detailsEl) detailsEl.textContent = 
                        `${this.currentJob.customer} â€¢ ${this.currentJob.start_time}`;
                }
            }
        }
    }

    function statusUpdateModal() {
        return {
            isOpen: false,
            currentJobId: null,
            
            open(jobId) {
                this.currentJobId = jobId;
                this.isOpen = true;
            },
            
            close() {
                this.isOpen = false;
                this.currentJobId = null;
                const form = document.getElementById('status-update-form');
                if (form) form.reset();
            }
        }
    }
    
    // Make them available globally
    window.quickActionsModal = quickActionsModal;
    window.statusUpdateModal = statusUpdateModal;
    
    // Also register with Alpine if it's available
    if (typeof Alpine !== 'undefined') {
        Alpine.data('quickActionsModal', quickActionsModal);
        Alpine.data('statusUpdateModal', statusUpdateModal);
    } else {
        // Register when Alpine becomes available
        document.addEventListener('alpine:init', () => {
            Alpine.data('quickActionsModal', quickActionsModal);
            Alpine.data('statusUpdateModal', statusUpdateModal);
        });
    }
})();
</script>
<style>
/* Status indicator styles for calendar events */
.status-pending {
    background-color: #fbbf24;
}

.status-confirmed {
    background-color: #3b82f6;
}

.status-in_progress {
    background-color: #f97316;
}

.status-completed {
    background-color: #10b981;
}

/* Responsive adjustments for compact toolbar */
@media (max-width: 768px) {
    .flex-wrap {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
}

/* Full-bleed calendar styles */
.full-bleed {
    width: 100vw;
    margin-left: 50%;
    transform: translateX(-50%);
}

/* Allow FullCalendar to be as wide as its parent */
.fc { 
    max-width: none !important; 
    margin: 0 !important; 
    height: 100%;
}

/* Calendar should consume the viewport height below the navbar */
#calendar-wrap {
    /* adjust 120px if your header area is taller/shorter */
    height: calc(100vh - 120px);
}

/* Make the FullCalendar canvas fill its parent */
#calendar { 
    height: 100%; 
}

/* Calendar and Status filter dropdown styling */
#calendar-filter, #status-filter {
    background: #f8f9fa !important;
    border: 1px solid #dee2e6 !important;
    color: #495057 !important;
    font-size: 14px !important;
    font-weight: normal !important;
    padding: 6px 12px !important;
    margin: 0 !important;
    cursor: pointer !important;
    outline: none !important;
    border-radius: 4px !important;
    min-width: 120px !important;
    transition: all 0.2s ease !important;
}

#calendar-filter:hover, #status-filter:hover {
    background: #e9ecef !important;
    border-color: #adb5bd !important;
}

#calendar-filter:focus, #status-filter:focus {
    background: #ffffff !important;
    border-color: #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

/* Style the filter button containers */
.fc-calendarFilterButton-button, .fc-statusFilterButton-button {
    padding: 0 !important;
    margin: 0 4px !important;
    background: transparent !important;
    border: none !important;
}
</style>
{% endblock %}

{% block main_container_class %}full-bleed{% endblock %}

{% block content %}
<div id="calendar-shell" class="container-fluid px-3">
    <div id="calendar-wrap">
        <div id="calendar"></div>
        
        <!-- Loading State -->
        <div id="calendar-loading" class="calendar-loading hidden">
            {% include "rental_scheduler/components/loading.html" with 
                type="spinner" 
                size="lg" 
                text="Loading calendar..." %}
        </div>
    </div>
</div>

<!-- Quick Actions Modal -->
<div id="quick-actions-modal" x-data="quickActionsModal()" 
     x-show="isOpen" 
     x-cloak
     class="fixed inset-0 z-50 overflow-y-auto"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="close()"></div>
    
    <!-- Modal panel -->
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
            
            <!-- Header -->
            <div class="bg-gray-50 px-4 py-3 sm:px-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium leading-6 text-gray-900">Quick Actions</h3>
                    <button @click="close()" type="button" class="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="px-4 py-5 sm:p-6">
                <div class="quick-actions-content">
                    <div class="job-info mb-4">
                        <h4 class="text-lg font-medium text-gray-900 mb-2" id="modal-job-title"></h4>
                        <p class="text-sm text-gray-600" id="modal-job-details"></p>
                    </div>
                    
                    <div class="status-actions mb-4">
                        <h5 class="text-sm font-medium text-gray-700 mb-2">Update Status</h5>
                        <div class="grid grid-cols-2 gap-2">
                            {% for status_value, status_display in status_choices %}
                            <button class="status-action-btn status-{{ status_value|lower }}"
                                    data-status="{{ status_value }}"
                                    onclick="updateJobStatus('{{ status_value }}')">
                                {% include "rental_scheduler/components/status_pill.html" with status=status_display %}
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="action-btn edit-btn" onclick="editJob()">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                            </svg>
                            Edit Job
                        </button>
                        <button class="action-btn view-btn" onclick="viewJob()">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                            </svg>
                            View Details
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                {% include "rental_scheduler/components/button.html" with 
                    text="Close" 
                    variant="outline" 
                    size="md"
                    onclick="closeQuickActions()" %}
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div id="status-update-modal" x-data="statusUpdateModal()" 
     x-show="isOpen" 
     x-cloak
     class="fixed inset-0 z-50 overflow-y-auto"
     x-transition:enter="transition ease-out duration-300"
     x-transition:enter-start="opacity-0"
     x-transition:enter-end="opacity-100"
     x-transition:leave="transition ease-in duration-200"
     x-transition:leave-start="opacity-100"
     x-transition:leave-end="opacity-0">
    
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="close()"></div>
    
    <!-- Modal panel -->
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
             x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
             x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95">
            
            <!-- Header -->
            <div class="bg-gray-50 px-4 py-3 sm:px-6">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium leading-6 text-gray-900">Update Job Status</h3>
                    <button @click="close()" type="button" class="rounded-md bg-white text-gray-400 hover:text-gray-500 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        <span class="sr-only">Close</span>
                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Content -->
            <div class="px-4 py-5 sm:p-6">
                <form id="status-update-form" class="status-update-form">
                    <div class="form-group mb-4">
                        <label for="new-status" class="form-label">New Status</label>
                        <select id="new-status" name="status" class="form-input" required>
                            {% for status_value, status_display in status_choices %}
                            <option value="{{ status_value }}">{{ status_display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group mb-4">
                        <label for="status-notes" class="form-label">Notes (Optional)</label>
                        <textarea id="status-notes" name="notes" class="form-input" rows="3" 
                                  placeholder="Add any notes about this status change..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="send-notification" name="send_notification" class="mr-2">
                            Send notification to customer
                        </label>
                    </div>
                </form>
            </div>
            
            <!-- Footer -->
            <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6">
                {% include "rental_scheduler/components/button.html" with 
                    text="Cancel" 
                    variant="outline" 
                    size="md"
                    onclick="closeStatusUpdate()" %}
                {% include "rental_scheduler/components/button.html" with 
                    text="Update Status" 
                    variant="primary" 
                    size="md"
                    onclick="submitStatusUpdate()" %}
            </div>
        </div>
    </div>
</div>

<script>
// Calendar configuration and data
window.calendarConfig = {
    eventsUrl: "{% url 'rental_scheduler:job_calendar_data' %}",
    jobUpdateUrl: "{% url 'rental_scheduler:update_job_status' 0 %}".replace('/0/', '/'),
    jobDetailUrl: "{% url 'rental_scheduler:job_detail' 0 %}".replace('/0/', '/'),
    jobEditUrl: "{% url 'rental_scheduler:job_update' 0 %}".replace('/0/', '/'),
    jobCreateUrl: "{% url 'rental_scheduler:job_create' %}",
    csrfToken: "{{ csrf_token }}",
    calendars: JSON.parse('{{ calendars_json|default:"[]"|escapejs }}'),
    statusChoices: JSON.parse('{{ status_choices|default:"[]"|escapejs }}'),
    currentFilters: {
        calendar: "{{ request.GET.calendar|default:'' }}",
        status: "{{ request.GET.status|default:'' }}",
        search: "{{ request.GET.search|default:'' }}"
    },
    // Load saved filters from localStorage on page load
    savedFilters: (function() {
        try {
            const saved = localStorage.getItem('gts-calendar-filters');
            return saved ? JSON.parse(saved) : {};
        } catch (error) {
            console.warn('Error loading saved filters:', error);
            return {};
        }
    })()
};


// Alpine.js components are now defined in the head section

// Global functions for modal interactions
function openQuickActions(jobData) {
    document.getElementById('quick-actions-modal').__x.$data.open(jobData);
}

function closeQuickActions() {
    document.getElementById('quick-actions-modal').__x.$data.close();
}

function openStatusUpdate(jobId) {
    document.getElementById('status-update-modal').__x.$data.open(jobId);
}

function closeStatusUpdate() {
    document.getElementById('status-update-modal').__x.$data.close();
}

function updateJobStatus(status) {
    const jobId = document.getElementById('quick-actions-modal').__x.$data.currentJob?.id;
    if (jobId) {
        openStatusUpdate(jobId);
        document.getElementById('new-status').value = status;
        closeQuickActions();
    }
}

function editJob() {
    const jobId = document.getElementById('quick-actions-modal').__x.$data.currentJob?.id;
    if (jobId) {
        window.location.href = window.calendarConfig.jobEditUrl + jobId + '/';
    }
}

function viewJob() {
    const jobId = document.getElementById('quick-actions-modal').__x.$data.currentJob?.id;
    if (jobId) {
        window.location.href = window.calendarConfig.jobDetailUrl + jobId + '/';
    }
}

function submitStatusUpdate() {
    const form = document.getElementById('status-update-form');
    const formData = new FormData(form);
    const jobId = document.getElementById('status-update-modal').__x.$data.currentJobId;
    
    if (!jobId) return;
    
    formData.append('job_id', jobId);
    formData.append('csrfmiddlewaretoken', window.calendarConfig.csrfToken);
    
    fetch(window.calendarConfig.jobUpdateUrl, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            if (window.layout && window.layout.showToast) {
                window.layout.showToast('Job status updated successfully', 'success');
            }
            
            // Refresh calendar
            if (window.calendar && window.calendar.refetchEvents) {
                window.calendar.refetchEvents();
            }
            
            closeStatusUpdate();
        } else {
            // Show error message
            if (window.layout && window.layout.showToast) {
                window.layout.showToast(data.error || 'Failed to update job status', 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error updating job status:', error);
        if (window.layout && window.layout.showToast) {
            window.layout.showToast('Network error occurred', 'error');
        }
    });
}


// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Page initialization code can go here if needed
});
</script>
{% endblock %}

{% block extra_js %}
<script src="{% static 'rental_scheduler/js/job_calendar.js' %}"></script>
{% endblock %}