{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link href="{% static 'rental_scheduler/css/calendar.css' %}"
          rel="stylesheet">
    <link href="{% static 'rental_scheduler/css/job_calendar.css' %}"
          rel="stylesheet">

    <style>
    /* Status indicator styles for calendar events */
    .status-pending {
        background-color: #fbbf24;
    }

    .status-confirmed {
        background-color: #3b82f6;
    }

    .status-in_progress {
        background-color: #f97316;
    }

    .status-completed {
        background-color: #10b981;
    }

    /* Responsive adjustments for compact toolbar */
    @media (max-width: 768px) {
        .flex-wrap {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }

    /* Prevent body/html overflow and scrolling */
    html,
    body {
        overflow: hidden !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    /* Hidden utility class */
    .hidden {
        display: none !important;
    }

    /* Loading indicator styling */
    .calendar-loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: rgba(255, 255, 255, 0.95);
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* No calendars selected overlay styling */
    .calendar-no-calendars {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 999;
        background: rgba(255, 255, 255, 0.98);
        padding: 3rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        text-align: center;
    }

    /* Spinner animation */
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .animate-spin {
        animation: spin 1s linear infinite;
    }

    /* Flex utilities */
    .flex {
        display: flex;
    }

    .flex-col {
        flex-direction: column;
    }

    .items-center {
        align-items: center;
    }

    .justify-center {
        justify-content: center;
    }

    .space-y-4>*+* {
        margin-top: 1rem;
    }

    /* Full-bleed calendar styles */
    .full-bleed {
        width: 100vw;
        margin-left: 50%;
        transform: translateX(-50%);
    }

    /* Allow FullCalendar to be as wide as its parent and fill height */
    .fc {
        max-width: none !important;
        margin: 0 !important;
        height: 100% !important;
        display: flex !important;
        flex-direction: column !important;
    }

    /* FullCalendar header toolbar stays at top */
    .fc-header-toolbar {
        flex-shrink: 0 !important;
    }

    /* Make FullCalendar view fill remaining space */
    .fc-view-harness {
        flex: 1 1 auto !important;
        height: 0 !important;
        /* Reset height so flex can work */
        min-height: 0 !important;
    }

    /* Ensure daygrid view fills container */
    .fc-daygrid {
        height: 100% !important;
    }

    /* Scrollgrid must fill height */
    .fc-scrollgrid {
        height: 100% !important;
    }

    .fc-scrollgrid>tbody {
        height: 100% !important;
    }

    /* Make scrollgrid sections fill properly */
    .fc-scrollgrid-section {
        height: auto !important;
    }

    /* Header section stays small */
    .fc-scrollgrid-section-header {
        height: auto !important;
    }

    /* Body section with weeks takes all remaining space */
    .fc-scrollgrid-section-body {
        height: 100% !important;
    }

    .fc-scrollgrid-section-body>td {
        height: 100% !important;
        position: relative !important;
    }

    /* The tr that contains the body section must expand */
    .fc-scrollgrid>tbody>tr.fc-scrollgrid-section {
        height: auto !important;
    }

    .fc-scrollgrid>tbody>tr.fc-scrollgrid-section:has(.fc-scrollgrid-section-body) {
        height: 100% !important;
    }

    /* Daygrid body must expand to fill */
    .fc-daygrid-body {
        height: 100% !important;
    }

    .fc-daygrid-body-balanced {
        height: 100% !important;
    }

    .fc-daygrid-body-unbalanced {
        height: 100% !important;
    }

    .fc-daygrid-body>tr {
        height: 100% !important;
    }

    .fc-daygrid-body>tr>td {
        height: 100% !important;
    }

    /* Ensure the scrollgrid inner table fills the section */
    .fc-scrollgrid-section-body .fc-scrollgrid-sync-inner {
        height: 100% !important;
    }

    /* Make sure the liquid section (body with weeks) takes full height */
    .fc-scrollgrid-section-liquid {
        height: 100% !important;
    }

    .fc-scrollgrid-section-liquid>td {
        height: 100% !important;
    }

    /* Search Panel Styles */
    #calendar-search-panel {
        height: 0;
        overflow: hidden;
        transition: height 0.3s ease-in-out;
        background: white;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
    }

    /* Fix search input padding to prevent text from overlaying icon */
    #calendar-search-input {
        padding-left: 36px !important;
    }

    #calendar-search-panel.open {
        height: 50vh;
    }

    #search-panel-content {
        padding: 0.5rem 1rem;
        height: 100%;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    #search-results-container {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        margin-top: 0.5rem;
    }

    #search-results-container::-webkit-scrollbar {
        width: 8px;
    }

    #search-results-container::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    #search-results-container::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    #search-results-container::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Compact table styling for search results */
    #search-results table {
        font-size: 0.875rem;
    }

    #search-results th {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.75rem !important;
    }

    #search-results td {
        padding: 0.5rem 0.75rem !important;
        font-size: 0.875rem !important;
    }

    #search-results .job-row {
        line-height: 1.25 !important;
    }

    #search-results .badge,
    #search-results .status-badge {
        padding: 0.125rem 0.5rem !important;
        font-size: 0.75rem !important;
    }

    /* Search & Today toggle button styling - white with grey border when inactive, blue when expanded */
    .fc-searchButton-button,
    .fc-todaySidebarButton-button {
        background-color: white !important;
        border-color: #d1d5db !important;
        color: #374151 !important;
    }

    .fc-searchButton-button:hover,
    .fc-todaySidebarButton-button:hover {
        background-color: #f9fafb !important;
        border-color: #9ca3af !important;
    }

    .fc-searchButton-button.active,
    .fc-todaySidebarButton-button.active {
        background-color: #2563eb !important;
        border-color: #2563eb !important;
        color: white !important;
    }

    .fc-searchButton-button.active:hover,
    .fc-todaySidebarButton-button.active:hover {
        background-color: #1d4ed8 !important;
        border-color: #1d4ed8 !important;
        color: white !important;
    }

    /* Calendar shell should fit viewport minus bottom workspace bar */
    #calendar-shell {
        height: calc(100vh - 45px) !important;
        /* Subtract bottom workspace bar height */
        overflow: hidden;
        padding: 0 12px !important;
        box-sizing: border-box;
        overscroll-behavior: none;
        display: flex !important;
        flex-direction: column !important;
        transition: height 0.3s ease-in-out;
    }

    /* Calendar should fill available space in flex container */
    #calendar-wrap {
        height: 100%;
        overflow: hidden;
        position: relative;
        overscroll-behavior: none;
    }

    /* Force equal height for all table rows (weeks) - CRITICAL */
    .fc-scrollgrid-sync-table {
        height: 100% !important;
        table-layout: fixed !important;
        border-collapse: collapse !important;
        width: 100% !important;
    }

    .fc-scrollgrid-sync-table tbody {
        height: 100% !important;
        display: table-row-group !important;
    }

    /* Ensure table respects height constraints */
    .fc-daygrid-body table {
        height: 100% !important;
        table-layout: fixed !important;
    }

    /* Each week row gets exactly 25% - ABSOLUTE */
    .fc-scrollgrid-sync-table tbody tr {
        height: 25% !important;
        max-height: 25% !important;
        min-height: 25% !important;
        display: table-row !important;
        overflow: hidden !important;
    }

    .fc-scrollgrid-sync-table tbody tr td {
        height: 100% !important;
        max-height: 100% !important;
        vertical-align: top !important;
        padding: 0 !important;
        overflow: hidden !important;
    }

    /* Target each week individually with nuclear option */
    .fc-daygrid-body table tbody tr:nth-child(1) {
        height: 25% !important;
        max-height: 25% !important;
        min-height: 25% !important;
    }

    .fc-daygrid-body table tbody tr:nth-child(2) {
        height: 25% !important;
        max-height: 25% !important;
        min-height: 25% !important;
    }

    .fc-daygrid-body table tbody tr:nth-child(3) {
        height: 25% !important;
        max-height: 25% !important;
        min-height: 25% !important;
    }

    .fc-daygrid-body table tbody tr:nth-child(4) {
        height: 25% !important;
        max-height: 25% !important;
        min-height: 25% !important;
    }

    /* Ensure daygrid-week class rows are equal */
    .fc-daygrid-week {
        height: 25% !important;
        max-height: 25% !important;
        min-height: 25% !important;
        overflow: hidden !important;
    }

    /* Force day cells to fill their row height */
    .fc-daygrid-day-frame {
        height: 100% !important;
        display: flex !important;
        flex-direction: column !important;
        max-height: 100% !important;
        overflow: hidden !important;
    }

    /* Day top (contains day number) stays at top */
    .fc-daygrid-day-top {
        flex-shrink: 0 !important;
        padding: 4px !important;
        height: auto !important;
        max-height: 30px !important;
    }

    /* Events container fills remaining space and scrolls */
    .fc-daygrid-day-events {
        flex: 1 1 0 !important;
        overflow-y: scroll !important;
        overflow-x: hidden !important;
        min-height: 0 !important;
        max-height: 100% !important;
        position: relative !important;
        pointer-events: auto !important;
        z-index: 1 !important;
    }

    /* Scrollbar styling for day events */
    .fc-daygrid-day-events::-webkit-scrollbar {
        width: 12px;
        cursor: pointer;
    }

    .fc-daygrid-day-events::-webkit-scrollbar-track {
        background: #d1d5db;
        border-radius: 6px;
        margin: 2px 0;
    }

    .fc-daygrid-day-events::-webkit-scrollbar-thumb {
        background: #6b7280;
        border-radius: 6px;
        border: 2px solid #d1d5db;
        cursor: grab;
    }

    .fc-daygrid-day-events::-webkit-scrollbar-thumb:hover {
        background: #4b5563;
    }

    .fc-daygrid-day-events::-webkit-scrollbar-thumb:active {
        background: #374151;
        cursor: grabbing;
    }

    /* Bottom padding area (if any) */
    .fc-daygrid-day-bottom {
        flex-shrink: 0 !important;
        display: none !important;
    }

    /* Prevent day bg events from expanding */
    .fc-daygrid-day-bg {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        bottom: 0 !important;
    }

    /* Prevent event harnesses from expanding the cell */
    .fc-daygrid-event-harness {
        margin: 1px 0 !important;
    }

    /* Prevent more link from expanding */
    .fc-daygrid-more-link {
        display: none !important;
    }

    /* Day cell content must not expand */
    .fc-daygrid-day-events,
    .fc-daygrid-event-harness,
    .fc-daygrid-event {
        flex-shrink: 0 !important;
    }

    /* Make the FullCalendar canvas fill its parent */
    #calendar {
        height: 100%;
        overflow: hidden;
        overscroll-behavior: none;
    }

    /* Calendar and Status filter dropdown styling */
    #calendar-filter,
    #status-filter {
        background: #f8f9fa !important;
        border: 1px solid #dee2e6 !important;
        color: #495057 !important;
        font-size: 14px !important;
        font-weight: normal !important;
        padding: 6px 12px !important;
        margin: 0 !important;
        cursor: pointer !important;
        outline: none !important;
        border-radius: 4px !important;
        min-width: 120px !important;
        transition: all 0.2s ease !important;
    }

    #calendar-filter:hover,
    #status-filter:hover {
        background: #e9ecef !important;
        border-color: #adb5bd !important;
    }

    #calendar-filter:focus,
    #status-filter:focus {
        background: #ffffff !important;
        border-color: #007bff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    }

    /* Style the filter button containers */
    .fc-calendarFilterButton-button,
    .fc-statusFilterButton-button {
        padding: 0 !important;
        margin: 0 4px !important;
        background: transparent !important;
        border: none !important;
    }

    /* Style all custom buttons to match dropdowns */
    .fc-jobsButton-button,
    .fc-settingsButton-button,
    .fc-addJobButton-button {
        background: #f8f9fa !important;
        border: 1px solid #dee2e6 !important;
        color: #495057 !important;
        font-size: 14px !important;
        font-weight: normal !important;
        padding: 6px 12px !important;
        margin: 0 4px !important;
        cursor: pointer !important;
        outline: none !important;
        border-radius: 4px !important;
        min-width: 120px !important;
        transition: all 0.2s ease !important;
    }

    .fc-jobsButton-button:hover,
    .fc-settingsButton-button:hover,
    .fc-addJobButton-button:hover {
        background: #e9ecef !important;
        border-color: #adb5bd !important;
    }

    .fc-jobsButton-button:focus,
    .fc-settingsButton-button:focus,
    .fc-addJobButton-button:focus {
        background: #ffffff !important;
        border-color: #007bff !important;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
    }

    /* Make calendar title flow naturally with navigation buttons */
    .fc-toolbar-title {
        font-size: 1rem !important;
        font-weight: 500 !important;
        text-align: left !important;
        position: static !important;
        display: inline-block !important;
        margin: 0 12px !important;
        padding: 4px 8px !important;
        max-width: none !important;
        overflow: visible !important;
        white-space: nowrap !important;
    }

    /* Make navigation buttons smaller */
    .fc-prev-button,
    .fc-next-button,
    .fc-today-button {
        font-size: 0.875rem !important;
        padding: 4px 8px !important;
        min-height: 28px !important;
    }

    /* Reduce top padding of calendar */
    .fc-header-toolbar {
        margin-bottom: 0.5rem !important;
        padding-top: 0.5rem !important;
        position: relative !important;
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
    }

    /* Make center toolbar section display items in a row */
    .fc-toolbar-chunk {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
    }

    /* Left section with navigation and title */
    .fc-toolbar-chunk:nth-child(1) {
        display: flex !important;
        align-items: center !important;
        justify-content: flex-start !important;
        gap: 4px !important;
    }

    /* Responsive adjustments for calendar toolbar on smaller screens */
    @media (max-width: 1650px) {
        .fc-toolbar-title {
            font-size: 0.9rem !important;
            margin: 0 8px !important;
        }

        /* Make buttons and dropdowns slightly smaller */
        .fc-jobsButton-button,
        .fc-settingsButton-button,
        .fc-addJobButton-button,
        #calendar-filter,
        #status-filter {
            font-size: 12px !important;
            padding: 5px 9px !important;
            min-width: 85px !important;
        }
    }

    @media (max-width: 1400px) {
        .fc-toolbar-title {
            font-size: 0.85rem !important;
            margin: 0 6px !important;
        }

        /* Make buttons and dropdowns even smaller */
        .fc-jobsButton-button,
        .fc-settingsButton-button,
        .fc-addJobButton-button,
        #calendar-filter,
        #status-filter {
            font-size: 11px !important;
            padding: 4px 8px !important;
            min-width: 75px !important;
        }
    }

    @media (max-width: 1100px) {

        /* Make toolbar wrap on smaller screens */
        .fc-header-toolbar {
            flex-wrap: wrap !important;
            gap: 8px !important;
        }

        /* Left section takes full width on smaller screens */
        .fc-toolbar-chunk:nth-child(1) {
            flex-basis: 100% !important;
            order: 1 !important;
        }

        .fc-toolbar-title {
            font-size: 0.85rem !important;
        }
    }

    @media (max-width: 768px) {

        /* Stack toolbar elements vertically on very small screens */
        .fc-header-toolbar {
            flex-direction: column !important;
            align-items: stretch !important;
        }

        .fc-toolbar-chunk {
            width: 100% !important;
            justify-content: flex-start !important;
        }

        /* Left section with navigation on mobile */
        .fc-toolbar-chunk:nth-child(1) {
            margin-bottom: 8px !important;
            order: -1 !important;
        }

        .fc-toolbar-title {
            font-size: 0.8rem !important;
            margin: 0 6px !important;
        }

        /* Make buttons and dropdowns even smaller on mobile */
        .fc-jobsButton-button,
        .fc-settingsButton-button,
        .fc-addJobButton-button,
        #calendar-filter,
        #status-filter {
            font-size: 11px !important;
            padding: 4px 8px !important;
            min-width: 70px !important;
        }
    }

    /* Make Sunday column half as wide as other days - using JavaScript instead */

    /* Custom view handles week display, no need to hide weeks */

    /* Two-column layout for calendar and Today sidebar */
    .cal-page {
        display: flex;
        gap: 16px;
        align-items: stretch;
        height: 100% !important;
        flex: 1 1 auto !important;
        overflow: hidden;
        overscroll-behavior: none;
    }

    #calendar-wrap {
        flex: 1 1 auto;
        min-width: 0;
        position: relative;
        overscroll-behavior: none;
        z-index: 1;
    }

    .today-sidebar {
        width: 340px;
        border-left: 1px solid #e5e7eb;
        padding: 12px;
        background: #fafafa;
        display: flex;
        flex-direction: column;
        position: relative;
        min-width: 10px;
        max-width: 1200px;
        height: 100%;
        overflow: hidden;
        overscroll-behavior: contain;
        z-index: 10;
        flex-shrink: 0;
        flex-grow: 0;
    }

    .today-sidebar.hidden {
        display: none !important;
    }

    .resize-handle {
        position: absolute;
        left: -4px;
        top: 0;
        bottom: 0;
        width: 16px;
        cursor: ew-resize;
        background: transparent;
        z-index: 100;
        transition: background 0.2s ease;
    }

    .resize-handle:hover,
    .resize-handle.active {
        background: rgba(59, 130, 246, 0.3);
    }

    .resize-handle::after {
        content: '';
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 4px;
        height: 60px;
        background: #6b7280;
        border-radius: 2px;
        opacity: 0.7;
        transition: all 0.2s ease;
    }

    .resize-handle:hover::after,
    .resize-handle.active::after {
        opacity: 1;
        background: #3b82f6;
    }

    .today-sidebar header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 8px;
        border-bottom: 1px solid #e5e7eb;
        padding-bottom: 8px;
    }

    .today-sidebar header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #374151;
    }

    .today-panel-title-btn {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #374151;
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        text-align: left;
        transition: color 0.2s ease;
    }

    .today-panel-title-btn:hover {
        color: #1f2937;
    }

    .today-panel-title-btn:active {
        color: #111827;
    }

    #todayDateLabel {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .today-list {
        flex: 1 1 auto;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0;
        overscroll-behavior: contain;
        -webkit-overflow-scrolling: touch;
    }

    .today-list::-webkit-scrollbar {
        width: 8px;
    }

    .today-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    .today-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    .today-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    .today-item {
        padding: 8px 6px;
        border-radius: 8px;
        margin-bottom: 6px;
        cursor: pointer;
        border: 1px solid #eee;
        background: white;
        transition: all 0.2s ease;
        color: white;
        font-weight: 500;
    }

    .today-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .today-item-time {
        font-weight: 600;
        margin-right: 6px;
        color: white;
        font-size: 0.875rem;
        opacity: 0.9;
    }

    .today-item-title {
        color: white;
        font-size: 0.875rem;
    }

    .today-item-sub {
        color: white;
        font-size: 0.75rem;
        margin-top: 2px;
        opacity: 0.8;
    }

    .today-empty {
        color: #777;
        padding: 8px 0;
        text-align: center;
        font-style: italic;
    }

    /* Date picker controls styling */
    .today-date-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .today-nav-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: #ffffff;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0;
    }

    .today-nav-btn:hover {
        background: #f3f4f6;
        border-color: #9ca3af;
        color: #1f2937;
    }

    .today-nav-btn:active {
        background: #e5e7eb;
        transform: translateY(1px);
    }

    .today-date-picker {
        flex: 1;
        height: 32px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        padding: 0 8px;
        font-size: 0.875rem;
        color: #374151;
        background: #ffffff;
        cursor: pointer;
        transition: border-color 0.2s ease;
    }

    .today-date-picker:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .today-date-picker:hover {
        border-color: #9ca3af;
    }

    /* Responsive design */
    @media (max-width: 1200px) {
        .cal-page {
            flex-direction: column;
        }

        .today-sidebar {
            width: 100%;
            border-left: none;
            border-top: 1px solid #e5e7eb;
            height: 50vh;
        }

        .today-list {
            flex: 1 1 auto;
            overflow-y: auto;
            min-height: 0;
        }
    }

    /* Ensure all day numbers are visible */
    .fc-daygrid-day-number {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        color: #374151 !important;
    }

    /* Make sure previous/next month dates are visible */
    .fc-daygrid-day.fc-day-other .fc-daygrid-day-number {
        color: #9CA3AF !important;
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
    }

    /* Ensure all day columns have equal width */
    .fc-col-header th {
        width: 14.29% !important;
        min-width: 14.29% !important;
        max-width: 14.29% !important;
    }

    /* More events popover styling - make it scrollable and position properly */
    .fc-popover {
        max-height: 70vh !important;
        overflow: hidden !important;
        display: flex !important;
        flex-direction: column !important;
        position: fixed !important;
        z-index: 1000 !important;
    }

    .fc-popover-header {
        flex-shrink: 0 !important;
    }

    .fc-popover-body {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        max-height: calc(70vh - 50px) !important;
        overscroll-behavior: contain !important;
    }

    .fc-popover-body::-webkit-scrollbar {
        width: 8px;
    }

    .fc-popover-body::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 4px;
    }

    .fc-popover-body::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
    }

    .fc-popover-body::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }

    /* Month name styling for first 7 days */
    .fc-month-name-wrapper {
        position: absolute !important;
        left: 4px !important;
        top: 4px !important;
        z-index: 2 !important;
    }

    .fc-month-name {
        font-size: 0.65rem !important;
        font-weight: 600 !important;
        color: #ffffff !important;
        text-transform: uppercase !important;
        letter-spacing: 0.05em !important;
        background-color: #3B82F6 !important;
        padding: 2px 8px !important;
        border-radius: 12px !important;
        display: inline-block !important;
    }

    /* Ensure day cell frame has relative positioning for absolute month name */
    .fc-daygrid-day-frame {
        position: relative !important;
    }
    </style>
{% endblock %}

{% block main_container_class %}
full-bleed
{% endblock %}

{% block content %}
    <!-- Search Panel -->
    <div id="calendar-search-panel">
        <div id="search-panel-content">
            <form method="get" id="calendar-search-form" class="mb-2">
                <!-- Filters and Search on Same Row -->
                <div class="flex flex-row gap-4 items-center flex-wrap">
                    <!-- Calendar Filter -->
                    <div style="flex: 0 0 280px;
                                min-width: 280px;
                                display: flex;
                                align-items: center;
                                gap: 0.75rem">
                        <label class="text-sm font-medium text-gray-700"
                               style="margin: 0;
                                      white-space: nowrap">
Calendars
                        </label>
                        <div class="relative" style="flex: 1; min-width: 180px;">
                            <button type="button"
                                    id="search-calendar-dropdown-btn"
                                    class="w-full flex items-center justify-between px-3 py-2 text-sm border border-gray-300 rounded-lg bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <span id="search-calendar-selected-text">All Calendars</span>
                                <svg class="w-4 h-4 text-gray-400"
                                     fill="none"
                                     stroke="currentColor"
                                     viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
</path>
                                </svg>
                            </button>
                            <div id="search-calendar-dropdown"
                                 class="hidden absolute w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-auto"
                                 style="z-index: 1000">
                                <!-- All Calendars select-all row -->
                                <label class="flex items-center px-4 py-2 hover:bg-gray-50 cursor-pointer border-b border-gray-200">
                                    <input type="checkbox"
                                           id="search-calendar-all-checkbox"
                                           class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                    <span class="ml-3 text-sm font-semibold text-gray-900">All Calendars</span>
                                </label>
                                {% for calendar in calendars %}
                                    <label class="flex items-center px-4 py-2 hover:bg-gray-50 cursor-pointer">
                                        <input type="checkbox"
                                               name="calendars"
                                               value="{{ calendar.id }}"
                                               class="search-calendar-checkbox w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        <span class="ml-3 flex items-center">
                                            <span class="inline-block w-3 h-3 rounded mr-2"
                                                  style="background-color: {{ calendar.color }}"></span>
                                            <span class="text-sm text-gray-700">{{ calendar.name }}</span>
                                        </span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Events Date Filter -->
                    <div style="display: flex; align-items: center; gap: 0.75rem;">
                        <label class="text-sm font-medium text-gray-700"
                               style="margin: 0;
                                      white-space: nowrap">
Events
                        </label>
                        <div class="flex items-center gap-3 flex-wrap">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio"
                                       name="date_filter"
                                       value="all"
                                       checked
                                       class="search-date-filter-radio w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 whitespace-nowrap">All Events</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio"
                                       name="date_filter"
                                       value="future"
                                       class="search-date-filter-radio w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 whitespace-nowrap">All Future</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio"
                                       name="date_filter"
                                       value="past"
                                       class="search-date-filter-radio w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 whitespace-nowrap">Past</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio"
                                       name="date_filter"
                                       value="current_view"
                                       class="search-date-filter-radio w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 whitespace-nowrap">Events in Current View</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio"
                                       name="date_filter"
                                       value="two_years"
                                       class="search-date-filter-radio w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700 whitespace-nowrap">Events within 2 years</span>
                            </label>
                        </div>
                        <!-- Hidden inputs to store current view dates -->
                        <input type="hidden" name="start_date" id="search-view-start-date">
                        <input type="hidden" name="end_date" id="search-view-end-date">
                    </div>

                    <!-- Search Bar -->
                    <div class="flex-1 flex items-center gap-2" style="min-width: 300px;">
                        <div class="flex-1 relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pointer-events-none"
                                 style="padding-left: 12px">
                                <svg class="w-4 h-4 text-gray-400"
                                     fill="none"
                                     stroke="currentColor"
                                     viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z">
</path>
                                </svg>
                            </div>
                            <input type="text"
                                   name="search"
                                   id="calendar-search-input"
                                   class="w-full pr-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   style="padding-left: 36px"
                                   placeholder="Search jobs..."
                                   autocomplete="off">
                        </div>
                        <button type="submit"
                                class="inline-flex items-center gap-1 px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors duration-200 shadow-sm hover:shadow-md whitespace-nowrap">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z">
</path>
                            </svg>
                        Search
                        </button>
                        <button type="button"
                                id="calendar-clear-search-btn"
                                class="inline-flex items-center gap-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg transition-colors duration-200 whitespace-nowrap">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
</path>
                            </svg>
                        Clear
                        </button>
                        <button type="button"
                                id="calendar-close-search-btn"
                                class="inline-flex items-center gap-1 px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 hover:bg-gray-50 rounded-lg transition-colors duration-200 whitespace-nowrap"
                                title="Close the search area">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7">
</path>
                            </svg>
                        Close Search
                        </button>
                    </div>
                </div>
            </form>

            <!-- Search Results -->
            <div id="search-results-container">
                <div id="search-results" class="text-center text-gray-500 py-0">
                Enter search criteria and click Search to see results.
                </div>
            </div>
        </div>
    </div>

    <div id="calendar-shell" class="container-fluid px-3">
        <div id="calendarPage" class="cal-page">
            <div id="calendar-wrap">
                <div id="calendar">
                </div>

                <!-- Loading State -->
                <div id="calendar-loading" class="calendar-loading hidden">
                    <div class="loading-component flex items-center justify-center p-8">
                        <div class="flex flex-col items-center space-y-4">
                            <div class="w-12 h-12 border-4 border-gray-200 border-t-blue-600 rounded-full animate-spin">
                            </div>
                            <p class="text-gray-600 text-sm font-medium">
Loading calendar...
                            </p>
                        </div>
                    </div>
                </div>

                <!-- No Calendars Selected State -->
                <div id="calendar-no-calendars" class="calendar-no-calendars hidden">
                    <div class="flex flex-col items-center space-y-4">
                        <svg class="w-16 h-16 text-gray-400"
                             fill="none"
                             stroke="currentColor"
                             viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
</path>
                        </svg>
                        <p class="text-gray-600 text-lg font-medium">
No calendars selected
                        </p>
                        <p class="text-gray-500 text-sm">
Select one or more calendars to view events
                        </p>
                        <button type="button"
                                id="calendar-select-all-btn"
                                class="mt-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                            Select All Calendars
                        </button>
                    </div>
                </div>
            </div>

            <aside id="todaySidebar" class="today-sidebar">
                <div class="resize-handle" id="sidebarResizeHandle">
                </div>
                <header>
                    <button id="todayPanelTitle" class="today-panel-title-btn">
Today
                    </button>
                    <div id="todayDateLabel">
                    </div>
                </header>
                <div class="today-date-controls">
                    <button id="prevDayBtn" class="today-nav-btn" title="Previous day">
                        <svg width="16"
                             height="16"
                             viewBox="0 0 24 24"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2">
<polyline points="15,18 9,12 15,6"></polyline>
                        </svg>
                    </button>
                    <input type="date" id="todayDatePicker" class="today-date-picker">
                    <button id="nextDayBtn" class="today-nav-btn" title="Next day">
                        <svg width="16"
                             height="16"
                             viewBox="0 0 24 24"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2">
<polyline points="9,18 15,12 9,6"></polyline>
                        </svg>
                    </button>
                    <button id="todayBtn" class="today-nav-btn" title="Go to today">
                        <svg width="16"
                             height="16"
                             viewBox="0 0 24 24"
                             fill="none"
                             stroke="currentColor"
                             stroke-width="2">
<circle cx="12" cy="12" r="10"></circle>
<polyline points="12,6 12,12 16,14"></polyline>
                        </svg>
                    </button>
                </div>
                <div id="todayList" class="today-list">
                </div>
            </aside>
        </div>
    </div>



    <script>
    // Calendar configuration and data (kept inline - required by job_calendar.js and calendar_page.js)
    window.calendarConfig = {
        csrfToken: "{{ csrf_token }}",
        calendars: JSON.parse('{{ calendars_json|default:"[]"|escapejs }}'),
        statusChoices: JSON.parse('{{ status_choices|default:"[]"|escapejs }}'),
        // Guardrails for date validation (from server constants.py - single source of truth)
        guardrails: JSON.parse('{{ guardrails_json|default:"{}"|escapejs }}'),
        currentFilters: {
            calendar: "{{ request.GET.calendar|default:'' }}",
            status: "{{ request.GET.status|default:'' }}",
            search: "{{ request.GET.search|default:'' }}"
        },
        // Load saved filters from localStorage on page load
        savedFilters: (function () {
            try {
                const saved = localStorage.getItem('gts-calendar-filters');
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                console.warn('Error loading saved filters:', error);
                return {};
            }
        })()
    };
    </script>
{% endblock %}
{% block extra_js %}
    <!-- Calendar module registry (must load first) -->
    <script src="{% static 'rental_scheduler/js/calendar/registry.js' %}?v={{ timestamp|default:'1' }}"></script>
    
    <!-- Calendar modules (order doesn't matter after registry) -->
    <script src="{% static 'rental_scheduler/js/calendar/utils.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/layout.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/events.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/today_sidebar.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/tooltips.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/rendering.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/day_interactions.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/toolbar.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/filters.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/job_actions.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/recurrence_virtual.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/call_reminders.js' %}?v={{ timestamp|default:'1' }}"></script>
    <script src="{% static 'rental_scheduler/js/calendar/core.js' %}?v={{ timestamp|default:'1' }}"></script>
    
    <!-- Main calendar entrypoint (applies mixins + instantiates) -->
    <script src="{% static 'rental_scheduler/js/job_calendar.js' %}?v={{ timestamp|default:'1' }}"></script>
    
    <!-- Calendar page behaviors (search panel, sidebar resize, etc.) -->
    <script src="{% static 'rental_scheduler/js/entrypoints/calendar_page.js' %}?v={{ timestamp|default:'1' }}"></script>
{% endblock %}
