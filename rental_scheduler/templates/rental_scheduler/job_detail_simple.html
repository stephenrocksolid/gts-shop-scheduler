{% extends "base.html" %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900">{{ title }}</h1>
        <div class="flex space-x-3">
            <a href="{% url 'rental_scheduler:job_update' job.pk %}" 
               class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                Edit Job
            </a>
            <a href="{% url 'rental_scheduler:job_list' %}" 
               class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                Back to Jobs
            </a>
        </div>
    </div>

     <!-- Job Status -->
     <div class="inline-flex items-center space-x-3 bg-white rounded-full shadow-sm border border-gray-200 px-3 py-1 mb-6">
         <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
             {% if job.status == 'uncompleted' %}bg-yellow-100 text-yellow-800
             {% elif job.status == 'completed' %}bg-green-100 text-green-800{% endif %}">
             {{ job.get_status_display }}
         </span>
         {% if job.is_overdue %}
             <span class="text-red-600 text-xs font-medium">⚠️ OVERDUE</span>
         {% endif %}
     </div>

    <!-- Scheduling and Customer Information Row -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <!-- Scheduling Information -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                    </svg>
                    Scheduling Information
                </h3>
            </div>
             <div class="px-6 py-4">
                 <div class="space-y-2">
                     <div class="text-sm">
                         <span class="font-medium text-gray-500">Calendar:</span>
                         <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ml-2" 
                               style="background-color: {{ job.calendar.color }}20; color: {{ job.calendar.color }};">
                             {{ job.calendar.name }}
                         </span>
                     </div>
                     <div class="text-sm">
                         <span class="font-medium text-gray-500">Start:</span>
                         <span class="text-gray-900 ml-2">
                             {{ job.start_dt|date:"F j, Y" }}{% if not job.all_day %} · {{ job.start_dt|time:"g:i A" }}{% endif %}
                         </span>
                     </div>
                     <div class="text-sm">
                         <span class="font-medium text-gray-500">End:</span>
                         <span class="text-gray-900 ml-2">
                             {{ job.end_dt|date:"F j, Y" }}{% if not job.all_day %} · {{ job.end_dt|time:"g:i A" }}{% endif %}
                         </span>
                     </div>
                     {% if job.repeat_type != 'none' %}
                         <div class="text-sm">
                             <span class="font-medium text-gray-500">Repeat:</span>
                             <span class="text-gray-900 ml-2">{{ job.get_repeat_type_display }}</span>
                         </div>
                     {% endif %}
                 </div>
             </div>
        </div>

        <!-- Customer Information -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-medium text-gray-900 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z" clip-rule="evenodd"/>
                    </svg>
                    Customer Information
                </h3>
            </div>
             <div class="px-6 py-4">
                 <div class="space-y-2">
                     {% if job.business_name %}
                         <div class="text-sm">
                             <span class="font-medium text-gray-500">Business:</span>
                             <span class="text-gray-900 ml-2">{{ job.business_name }}</span>
                         </div>
                     {% endif %}
                     {% if job.contact_name %}
                         <div class="text-sm">
                             <span class="font-medium text-gray-500">Contact:</span>
                             <span class="text-gray-900 ml-2">{{ job.contact_name }}</span>
                         </div>
                     {% endif %}
                     {% if job.phone %}
                         <div class="text-sm">
                             <span class="font-medium text-gray-500">Phone:</span>
                             <span class="text-gray-900 ml-2">{{ job.phone }}</span>
                         </div>
                     {% endif %}
                     {% if job.address_line1 %}
                         <div class="text-sm">
                             <span class="font-medium text-gray-500">Address:</span>
                             <span class="text-gray-900 ml-2">
                                 {{ job.address_line1 }}{% if job.address_line2 %}, {{ job.address_line2 }}{% endif %}{% if job.city or job.state or job.postal_code %}, {{ job.city }}{% if job.city and job.state %}, {% endif %}{{ job.state }} {{ job.postal_code }}{% endif %}
                             </span>
                         </div>
                     {% endif %}
                 </div>
             </div>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Column -->
        <div class="space-y-6">

        <!-- Right Column -->
        <div class="space-y-6">
            <!-- Trailer Information -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                        </svg>
                        Trailer Information
                    </h3>
                </div>
                 <div class="px-6 py-4">
                     <div class="space-y-2">
                         {% if job.trailer_color %}
                             <div class="text-sm">
                                 <span class="font-medium text-gray-500">Color:</span>
                                 <span class="text-gray-900 ml-2">{{ job.trailer_color }}</span>
                             </div>
                         {% endif %}
                         {% if job.trailer_serial %}
                             <div class="text-sm">
                                 <span class="font-medium text-gray-500">Serial:</span>
                                 <span class="text-gray-900 ml-2">{{ job.trailer_serial }}</span>
                             </div>
                         {% endif %}
                         {% if job.trailer_details %}
                             <div class="text-sm">
                                 <span class="font-medium text-gray-500">Details:</span>
                                 <span class="text-gray-900 ml-2">{{ job.trailer_details }}</span>
                             </div>
                         {% endif %}
                     </div>
                 </div>
            </div>

            <!-- Job Details -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        Job Details
                    </h3>
                </div>
                <div class="px-6 py-4">
                    {% if job.repair_notes %}
                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Repair Notes:</h4>
                            <div class="text-sm text-gray-900 bg-gray-50 p-3 rounded-md">{{ job.repair_notes|linebreaks }}</div>
                        </div>
                    {% endif %}
                    {% if job.quote_text %}
                        <div class="mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Quote:</h4>
                            <div class="text-sm text-gray-900 bg-gray-50 p-3 rounded-md">{{ job.quote_text|linebreaks }}</div>
                        </div>
                    {% endif %}
                    {% if job.notes %}
                        <div>
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Notes:</h4>
                            <div class="text-sm text-gray-900 bg-gray-50 p-3 rounded-md">{{ job.notes|linebreaks }}</div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <h3 class="text-lg font-medium text-gray-900">Actions</h3>
                </div>
                <div class="px-6 py-4">
                    <div class="flex flex-wrap gap-2">
                        {% if job.status == 'uncompleted' %}
                            <button onclick="updateJobStatus('completed')" 
                                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm transition duration-200">
                                Mark as Complete
                            </button>
                        {% endif %}
                        <a href="{% url 'rental_scheduler:job_update' job.pk %}" 
                           class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded text-sm transition duration-200">
                            Edit Job
                        </a>
                        <a href="{% url 'rental_scheduler:job_print_wo' job.pk %}" 
                           class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded text-sm transition duration-200">
                            Print Work Order
                        </a>
                        <a href="{% url 'rental_scheduler:job_print_invoice' job.pk %}" 
                           class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-3 rounded text-sm transition duration-200"
                           style="background-color: #ea580c !important; color: white !important;">
                            Print Invoice
                        </a>
                        <a href="{% url 'rental_scheduler:job_delete' job.pk %}" 
                           class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded text-sm transition duration-200">
                            Delete Job
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Job status update function
function updateJobStatus(status) {
    if (confirm(`Are you sure you want to mark this job as ${status}?`)) {
        // Get CSRF token from cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }
        
        fetch(`{% url 'rental_scheduler:update_job_status' job.id %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify({
                status: status
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                alert('Job status updated successfully!');
                // Reload page to show updated status
                window.location.reload();
            } else {
                alert(data.error || 'Failed to update status');
            }
        })
        .catch(error => {
            console.error('Error updating job status:', error);
            alert('Network error occurred');
        });
    }
}
</script>
{% endblock %}
