{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - GTS Scheduler{% endblock %}

{% block extra_css %}
<style>
    .settings-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .settings-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: #3b82f6;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .calendar-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        padding: 1.5rem;
        transition: all 0.2s ease;
    }
    
    .calendar-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    
    .calendar-name {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
    }
    
    .calendar-status {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .calendar-status.active {
        background: #dcfce7;
        color: #166534;
    }
    
    .calendar-status.inactive {
        background: #fef2f2;
        color: #dc2626;
    }
    
    .calendar-color-preview {
        width: 2rem;
        height: 2rem;
        border-radius: 0.5rem;
        border: 2px solid #e5e7eb;
        margin-bottom: 1rem;
    }
    
    .calendar-stats {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .calendar-stat {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .calendar-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    
    .btn-primary {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
    }
    
    .btn-primary:hover {
        background: #2563eb;
        border-color: #2563eb;
    }
    
    .btn-secondary {
        background: white;
        color: #374151;
        border-color: #d1d5db;
    }
    
    .btn-secondary:hover {
        background: #f9fafb;
        border-color: #9ca3af;
    }
    
    .btn-danger {
        background: #dc2626;
        color: white;
        border-color: #dc2626;
    }
    
    .btn-danger:hover {
        background: #b91c1c;
        border-color: #b91c1c;
    }
    
    .color-picker {
        width: 100%;
        height: 2.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        cursor: pointer;
    }
    
    .color-picker:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6b7280;
    }
    
    .empty-state-icon {
        width: 4rem;
        height: 4rem;
        margin: 0 auto 1rem;
        color: #d1d5db;
    }
    
    .loading {
        text-align: center;
        color: #6b7280;
        padding: 2rem;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid #e5e7eb;
        border-top: 2px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="settings-header">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Calendar Settings</h1>
        <p class="text-gray-600">Manage calendars, colors, and calendar-specific options</p>
    </div>
    
    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_calendars }}</div>
            <div class="stat-label">Total Calendars</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ active_calendars }}</div>
            <div class="stat-label">Active Calendars</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_calendars|add:"-1"|default:0 }}</div>
            <div class="stat-label">Inactive Calendars</div>
        </div>
    </div>
    
    <!-- Calendar Management -->
    <div class="flex justify-between items-center mb-4">
        <div>
            <h2 class="text-xl font-semibold text-gray-900">Calendar Management</h2>
            <p class="text-sm text-gray-600">Click on colors to change them, use toggle buttons to activate/deactivate</p>
        </div>
        <a href="{% url 'rental_scheduler:calendar_create' %}" class="btn btn-primary">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            Add Calendar
        </a>
    </div>
    
    <!-- Quick Actions -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <h3 class="text-sm font-semibold text-blue-900 mb-2">ðŸ’¡ Quick Actions</h3>
        <div class="flex flex-wrap gap-2 text-sm text-blue-700">
            <span>â€¢ Click color swatches to change calendar colors</span>
            <span>â€¢ Use toggle buttons to activate/deactivate calendars</span>
            <span>â€¢ Drag calendars to reorder (coming soon)</span>
        </div>
    </div>
    
    {% if calendars %}
        <div class="calendar-grid">
            {% for calendar in calendars %}
                <div class="calendar-card">
                    <div class="calendar-header">
                        <div class="calendar-name">{{ calendar.name }}</div>
                        <div class="calendar-status {% if calendar.is_active %}active{% else %}inactive{% endif %}" 
                             id="status-{{ calendar.id }}">
                            {% if calendar.is_active %}Active{% else %}Inactive{% endif %}
                        </div>
                    </div>
                    
                    <div class="calendar-color-preview" 
                         style="background-color: {{ calendar.color }};"
                         id="color-preview-{{ calendar.id }}"></div>
                    
                    <div class="calendar-stats">
                        <div class="calendar-stat">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                            </svg>
                            {{ calendar.job_count }} jobs
                        </div>
                        <div class="calendar-stat">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            Updated {{ calendar.updated_at|date:"M j, Y" }}
                        </div>
                    </div>
                    
                    <div class="calendar-actions">
                        <div class="relative group">
                            <input type="color" 
                                   class="color-picker" 
                                   value="{{ calendar.color }}"
                                   data-calendar-id="{{ calendar.id }}"
                                   hx-post="{% url 'rental_scheduler:update_calendar_color' calendar.id %}"
                                   hx-trigger="change"
                                   hx-target="#color-preview-{{ calendar.id }}"
                                   hx-swap="outerHTML"
                                   title="Click to change calendar color">
                            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap">
                                Change Color
                            </div>
                        </div>
                        
                        <button class="btn btn-secondary"
                                hx-post="{% url 'rental_scheduler:toggle_calendar_active' calendar.id %}"
                                hx-target="#status-{{ calendar.id }}"
                                hx-swap="outerHTML"
                                title="{% if calendar.is_active %}Click to deactivate calendar{% else %}Click to activate calendar{% endif %}">
                            {% if calendar.is_active %}Deactivate{% else %}Activate{% endif %}
                        </button>
                        
                        <a href="{% url 'rental_scheduler:calendar_update' calendar.id %}" class="btn btn-secondary" title="Edit calendar settings">
                            Edit
                        </a>
                        
                        {% if calendar.job_count == 0 %}
                            <a href="{% url 'rental_scheduler:calendar_delete' calendar.id %}" class="btn btn-danger" title="Delete calendar (no jobs assigned)">
                                Delete
                            </a>
                        {% else %}
                            <button class="btn btn-secondary opacity-50 cursor-not-allowed" title="Cannot delete calendar with assigned jobs">
                                Delete
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <h3 class="text-lg font-medium mb-2">No calendars found</h3>
            <p class="text-sm mb-4">Get started by creating your first calendar</p>
            <a href="{% url 'rental_scheduler:calendar_create' %}" class="btn btn-primary">
                Create Calendar
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
class CalendarSettingsManager {
    constructor() {
        this.setupEventListeners();
        this.setupHTMXHandlers();
    }
    
    setupEventListeners() {
        // Handle color picker changes with visual feedback
        document.querySelectorAll('.color-picker').forEach(picker => {
            picker.addEventListener('change', (e) => this.handleColorChange(e));
            picker.addEventListener('input', (e) => this.handleColorInput(e));
        });
        
        // Add keyboard navigation
        document.addEventListener('keydown', (e) => this.handleKeydown(e));
    }
    
    handleColorChange(e) {
        const picker = e.target;
        const calendarId = picker.dataset.calendarId;
        const colorPreview = document.getElementById(`color-preview-${calendarId}`);
        
        if (colorPreview) {
            colorPreview.style.backgroundColor = picker.value;
            this.showToast('success', `Calendar color updated to ${picker.value}`);
        }
    }
    
    handleColorInput(e) {
        const picker = e.target;
        const calendarId = picker.dataset.calendarId;
        const colorPreview = document.getElementById(`color-preview-${calendarId}`);
        
        if (colorPreview) {
            colorPreview.style.backgroundColor = picker.value;
        }
    }
    
    handleKeydown(e) {
        // Tab navigation for color pickers
        if (e.key === 'Tab') {
            const colorPickers = document.querySelectorAll('.color-picker');
            const currentIndex = Array.from(colorPickers).indexOf(document.activeElement);
            
            if (currentIndex !== -1) {
                if (e.shiftKey) {
                    // Shift+Tab: go to previous picker
                    const prevIndex = currentIndex > 0 ? currentIndex - 1 : colorPickers.length - 1;
                    colorPickers[prevIndex].focus();
                } else {
                    // Tab: go to next picker
                    const nextIndex = currentIndex < colorPickers.length - 1 ? currentIndex + 1 : 0;
                    colorPickers[nextIndex].focus();
                }
                e.preventDefault();
            }
        }
    }
    
    setupHTMXHandlers() {
        // Handle HTMX responses with better user feedback
        document.addEventListener('htmx:afterRequest', (event) => {
            if (event.detail.xhr.status === 200) {
                try {
                    const response = JSON.parse(event.detail.xhr.responseText);
                    if (response.success) {
                        this.showToast('success', response.message);
                        
                        // Update UI elements if needed
                        if (response.is_active !== undefined) {
                            this.updateCalendarStatus(event.target, response.is_active, response.status_text);
                        }
                    } else {
                        this.showToast('error', response.error || 'Operation failed');
                    }
                } catch (e) {
                    // Handle non-JSON responses
                    this.showToast('info', 'Operation completed');
                }
            } else {
                this.showToast('error', 'Operation failed. Please try again.');
            }
        });
        
        // Handle HTMX errors
        document.addEventListener('htmx:responseError', (event) => {
            this.showToast('error', 'Network error. Please check your connection.');
        });
    }
    
    updateCalendarStatus(button, isActive, statusText) {
        const statusElement = button.closest('.calendar-card').querySelector('.calendar-status');
        if (statusElement) {
            statusElement.textContent = statusText;
            statusElement.className = `calendar-status ${isActive ? 'active' : 'inactive'}`;
        }
        
        // Update button text
        button.textContent = isActive ? 'Deactivate' : 'Activate';
    }
    
    showToast(type, message) {
        // Create toast notification
        const toast = document.createElement('div');
        const borderColor = type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : 'border-blue-500';
        const textColor = type === 'success' ? 'text-green-700' : type === 'error' ? 'text-red-700' : 'text-blue-700';
        
        toast.className = `fixed top-4 right-4 z-50 bg-white border-l-4 ${borderColor} p-4 shadow-lg rounded max-w-sm`;
        
        toast.innerHTML = `
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    ${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium ${textColor}">${message}</p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
                        Ã—
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (toast.parentElement) {
                toast.remove();
            }
        }, 5000);
    }
}

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    new CalendarSettingsManager();
});
</script>
{% endblock %}

